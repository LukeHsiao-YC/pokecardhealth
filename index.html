<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¶å¯å¤¢å¥åº·å¤§æˆ° (PTCG å®Œæ•´è¦å‰‡ç‰ˆ)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        
        .battle-bg {
            background: radial-gradient(circle at center, #f8fafc 0%, #e2e8f0 100%);
            background-image: url('https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/background.png'); /* ç¤ºæ„åœ–ï¼Œå¯¦éš›ç”¨ CSS ç•« */
        }
        
        /* å±¬æ€§é¡è‰²èˆ‡èƒŒæ™¯ */
        .type-fighting { background-color: #C03028; color: white; }
        .type-normal { background-color: #A8A77A; color: white; }
        .type-water { background-color: #6390F0; color: white; }
        .type-fire { background-color: #EE8130; color: white; }
        .type-ghost { background-color: #735797; color: white; }
        .type-grass { background-color: #7AC74C; color: white; }

        .card-shadow {
            box-shadow: 2px 4px 10px rgba(0,0,0,0.3);
            transition: all 0.2s;
        }
        .card-shadow:hover {
            transform: translateY(-15px) scale(1.05);
            box-shadow: 4px 12px 20px rgba(0,0,0,0.4);
            z-index: 50;
        }

        /* å‹•ç•« */
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-2px, 0, 0); }
            20%, 80% { transform: translate3d(4px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-8px, 0, 0); }
            40%, 60% { transform: translate3d(8px, 0, 0); }
        }

        .damage-pop {
            animation: floatUp 1s ease-out forwards;
            text-shadow: 2px 2px 0 #fff;
        }
        @keyframes floatUp {
            0% { opacity: 1; transform:translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform:translate(-50%, -150%) scale(1.5); }
        }

        .attack-anim-right { animation: lungeRight 0.2s forwards; }
        @keyframes lungeRight { 0% { transform: translateX(0); } 50% { transform: translateX(60px); } 100% { transform: translateX(0); } }

        .attack-anim-left { animation: lungeLeft 0.2s forwards; }
        @keyframes lungeLeft { 0% { transform: translateX(0); } 50% { transform: translateX(-60px); } 100% { transform: translateX(0); } }

        /* è¡›æ•™è¦–çª— */
        .tip-box { animation: slideInTip 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes slideInTip { from { transform: translateX(100%) scale(0.8); opacity: 0; } to { transform: translateX(0) scale(1); opacity: 1; } }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="h-screen overflow-hidden select-none bg-slate-900 text-slate-800">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- è³‡æ–™åº« ---

        // å¯¶å¯å¤¢åŸå‹è³‡æ–™ (Player)
        const POKEMON_DB = {
            machamp: {
                id: 'machamp', name: 'æ€ªåŠ›', type: 'fighting', maxHp: 180,
                img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/68.png",
                desc: "è‚ŒåŠ›è¨“ç·´çš„å°ˆå®¶ã€‚",
                retreatCost: 2,
                moves: [
                    { name: "æ‰‹åˆ€", cost: 1, dmg: 40, tip: "è¦å¾‹çš„è‚ŒåŠ›è¨“ç·´å¯å¢åŠ éª¨è³ªå¯†åº¦ï¼Œé é˜²éª¨è³ªç–é¬†ï¼" },
                    { name: "å€ŸåŠ›æ‘”", cost: 3, dmg: 100, tip: "æ ¸å¿ƒè‚Œç¾¤å¼·å£¯ï¼Œèƒ½æœ‰æ•ˆæ¸›å°‘ä¸‹èƒŒç—›çš„ç™¼ç”Ÿç‡ã€‚" }
                ]
            },
            lucario: {
                id: 'lucario', name: 'è·¯å¡åˆ©æ­', type: 'fighting', maxHp: 140,
                img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/448.png",
                desc: "å°ˆæ³¨èˆ‡å¹³è¡¡çš„è±¡å¾µã€‚",
                retreatCost: 1,
                moves: [
                    { name: "ç™¼å‹", cost: 1, dmg: 30, tip: "åƒç‘œçˆæˆ–å¤ªæ¥µæ‹³é€™æ¨£çš„å¹³è¡¡é‹å‹•ï¼Œæœ‰åŠ©æ–¼é é˜²è·Œå€’ï¼" },
                    { name: "æ³¢å°å½ˆ", cost: 2, dmg: 80, tip: "é‹å‹•èƒ½ä¿ƒé€²å¤§è…¦åˆ†æ³Œè…¦å…§å•¡ï¼Œè®“å¿ƒæƒ…è®Šå¥½ï¼Œå°æŠ—æ†‚é¬±ï¼" }
                ]
            },
            cinderace: {
                id: 'cinderace', name: 'é–ƒç„°ç‹ç‰Œ', type: 'fire', maxHp: 150,
                img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/815.png",
                desc: "æœ‰æ°§é‹å‹•é«˜æ‰‹ã€‚",
                retreatCost: 1,
                moves: [
                    { name: "ç«èŠ±", cost: 1, dmg: 30, tip: "æœ‰æ°§é‹å‹•ï¼ˆå¦‚æ…¢è·‘ã€æ¸¸æ³³ï¼‰èƒ½å¢å¼·å¿ƒè‚ºåŠŸèƒ½ï¼Œç‡ƒç‡’è„‚è‚ªï¼" },
                    { name: "ç«ç„°çƒ", cost: 3, dmg: 120, tip: "æ¯é€±è‡³å°‘150åˆ†é˜çš„ä¸­ç­‰å¼·åº¦é‹å‹•ï¼Œèƒ½é™ä½å¿ƒè¡€ç®¡ç–¾ç—…é¢¨éšªã€‚" }
                ]
            },
            inteleon: {
                id: 'inteleon', name: 'åƒé¢é¿å½¹', type: 'water', maxHp: 130,
                img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/818.png",
                desc: "æ°´ä»½è£œå……èˆ‡ä»£è¬ã€‚",
                retreatCost: 1,
                moves: [
                    { name: "ç‹™æ“Š", cost: 1, dmg: 40, tip: "æ¯å¤©æ”å–è¶³å¤ æ°´åˆ†ï¼ˆé«”é‡x30ccï¼‰ï¼Œä¿ƒé€²æ–°é™³ä»£è¬ï¼Œå¹«åŠ©æ’æ¯’ï¼" },
                    { name: "é«˜å£“æ°´ç‚®", cost: 2, dmg: 90, tip: "å°‘å–å«ç³–é£²æ–™ï¼Œå¤šå–ç™½é–‹æ°´ï¼Œæ˜¯æ§åˆ¶é«”é‡æœ€ç°¡å–®çš„æ–¹æ³•ã€‚" }
                ]
            }
        };

        // æ•µäººè³‡æ–™ (Enemies)
        const ENEMIES = [
            {
                id: 'sedentary', name: "è«‹å‡ç‹", title: "ä¹…åé­”äºº", type: 'normal', maxHp: 150,
                img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/289.png",
                weakness: 'fighting',
                moves: [{ name: "å“ˆæ¬ ", dmg: 10 }, { name: "å·æ‡¶é‡å£“", dmg: 40 }]
            },
            {
                id: 'junkfood', name: "è—é£½æ —é¼ ", title: "é›¶é£Ÿå›¤ç©è€…", type: 'normal', maxHp: 160,
                img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/820.png",
                weakness: 'fighting',
                moves: [{ name: "å¤§å¿«æœµé ¤", dmg: 20 }, { name: "ç¨®å­æ©Ÿé—œæ§", dmg: 50 }]
            },
            {
                id: 'sugary', name: "æ€–æ€å£º", title: "ç³–åˆ†å¹½éˆ", type: 'ghost', maxHp: 140,
                img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/855.png",
                weakness: 'water', // è¨­å®šæ°´å‰‹ç³– (ç¨€é‡‹)
                moves: [{ name: "é©šåš‡", dmg: 30 }, { name: "ç´…èŒ¶ç ²", dmg: 60 }]
            },
            {
                id: 'boss', name: "å¡æ¯”ç¸", title: "ä»£è¬ç—‡å€™ç¾¤", type: 'normal', maxHp: 250,
                img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/143.png",
                weakness: 'fighting',
                moves: [{ name: "æ³°å±±å£“é ‚", dmg: 60 }, { name: "ç¡è¦º", dmg: 0, heal: 50 }]
            }
        ];

        // å¡ç‰Œæ¨¡æ¿
        // ä¿®æ”¹ï¼šå¢åŠ å¯¶å¯å¤¢æ•¸é‡ï¼Œæ¸›å°‘èƒ½é‡å¡ï¼ŒåŠ å…¥å…ˆæ©Ÿçƒ
        const BASE_DECK = [
            // èƒ½é‡å¡ (14å¼µ) - æ¸›å°‘èƒ½é‡å¡æ¯”ä¾‹
            ...Array(14).fill({ type: 'energy', name: "åŸºæœ¬èƒ½é‡", desc: "æä¾›æ‹›å¼æ‰€éœ€èƒ½é‡" }),
            // ç‰©å“/æ”¯æ´è€… (12å¼µ)
            ...Array(3).fill({ type: 'item', effect: 'potion', name: "å‚·è—¥", desc: "æ¢å¾© 50 HP", val: 50 }),
            ...Array(2).fill({ type: 'item', effect: 'switch', name: "å¯¶å¯å¤¢äº¤æ›¿", desc: "å°‡æˆ°é¬¥å¯¶å¯å¤¢èˆ‡å‚™æˆ°äº¤æ›" }),
            ...Array(2).fill({ type: 'item', effect: 'ball', name: "å…ˆæ©Ÿçƒ", desc: "å¾ç‰Œåº«æŠ½ 1 å¼µå¯¶å¯å¤¢å¡" }), // æ–°å¢ï¼šæª¢ç´¢å¡
            ...Array(3).fill({ type: 'supporter', effect: 'research', name: "åšå£«çš„ç ”ç©¶", desc: "ä¸Ÿæ£„æ‰‹ç‰ŒæŠ½ 4 å¼µ", val: 4 }),
            ...Array(2).fill({ type: 'supporter', effect: 'boss', name: "è€å¤§çš„æŒ‡ä»¤", desc: "å¼·åˆ¶å°æ‰‹æ›´æ›å¯¶å¯å¤¢ (å‚·å®³+æŠ½ç‰Œ)", val: 20 }),
            // åŸºç¤å¯¶å¯å¤¢å¡ (16å¼µ) - å¤§å¹…å¢åŠ æ•¸é‡ (å„4å¼µ)
            ...Array(4).fill({ type: 'pokemon', protoId: 'machamp' }),
            ...Array(4).fill({ type: 'pokemon', protoId: 'lucario' }),
            ...Array(4).fill({ type: 'pokemon', protoId: 'cinderace' }),
            ...Array(4).fill({ type: 'pokemon', protoId: 'inteleon' }),
        ];

        // --- çµ„ä»¶ ---

        const TypeBadge = ({ type }) => {
            const colors = {
                fighting: 'bg-red-700', normal: 'bg-stone-400', water: 'bg-blue-500', 
                fire: 'bg-orange-500', ghost: 'bg-purple-700', grass: 'bg-green-500'
            };
            const names = {
                fighting: 'æ ¼é¬¥', normal: 'ä¸€èˆ¬', water: 'æ°´', 
                fire: 'ç«', ghost: 'å¹½éˆ', grass: 'è‰'
            };
            return (
                <span className={`px-2 py-0.5 rounded text-xs font-bold text-white ${colors[type] || 'bg-gray-500'}`}>
                    {names[type] || type}
                </span>
            );
        };

        const App = () => {
            const [scene, setScene] = useState('menu');
            const [enemyIdx, setEnemyIdx] = useState(0);
            
            // ç©å®¶ç‹€æ…‹
            const [activePkmn, setActivePkmn] = useState(null);
            const [bench, setBench] = useState([]);
            const [hand, setHand] = useState([]);
            const [deck, setDeck] = useState([]);
            const [discard, setDiscard] = useState([]);
            
            // æ•µäººç‹€æ…‹
            const [enemyHp, setEnemyHp] = useState(100);
            const [enemyNextMove, setEnemyNextMove] = useState(null);

            // å›åˆæ§åˆ¶
            const [turn, setTurn] = useState('player');
            const [energyAttached, setEnergyAttached] = useState(false);
            const [supporterUsed, setSupporterUsed] = useState(false);

            // UI ç‹€æ…‹
            const [msg, setMsg] = useState("");
            const [floater, setFloater] = useState(null);
            const [tip, setTip] = useState(null);
            const [pAnim, setPAnim] = useState('');
            const [eAnim, setEAnim] = useState('');

            // åˆå§‹åŒ–éŠæˆ²
            const initGame = () => {
                setEnemyIdx(0);
                startLevel(0, true);
            };

            const startLevel = (idx, fullReset = false) => {
                const enemyProto = ENEMIES[idx];
                setEnemyHp(enemyProto.maxHp);
                
                if (fullReset) {
                    // å»ºç«‹åˆå§‹ç‰Œçµ„
                    const newDeck = [...BASE_DECK].sort(() => Math.random() - 0.5);
                    const initialHand = newDeck.slice(0, 7);
                    const remainingDeck = newDeck.slice(7);
                    
                    // åˆå§‹ Active (æ€ªåŠ›)
                    const starter = { ...POKEMON_DB.machamp, currentHp: POKEMON_DB.machamp.maxHp, energy: 0, instanceId: Date.now() };
                    
                    setActivePkmn(starter);
                    setBench([]);
                    setHand(initialHand);
                    setDeck(remainingDeck);
                    setDiscard([]);
                } else {
                    // ä¸‹ä¸€é—œçå‹µï¼šè£œæ»¿æ‰€æœ‰å¯¶å¯å¤¢ HP
                    if(activePkmn) setActivePkmn(p => ({...p, currentHp: p.maxHp}));
                    setBench(prev => prev.map(p => ({...p, currentHp: p.maxHp})));
                    drawCard(1);
                }

                setTurn('player');
                setEnergyAttached(false);
                setSupporterUsed(false);
                setMsg(`é­é‡æ•µäººï¼š${enemyProto.name}ï¼`);
                setTip(null);
                
                // æ•µäºº AI
                const move = enemyProto.moves[Math.floor(Math.random() * enemyProto.moves.length)];
                setEnemyNextMove(move);

                setScene('battle');
            };

            // æŠ½ç‰Œ
            const drawCard = (n = 1) => {
                if (deck.length === 0) {
                    // æ´—æ£„ç‰Œå †
                    if (discard.length === 0) {
                        setMsg("ç„¡ç‰Œå¯æŠ½ï¼");
                        return;
                    }
                    const newDeck = [...discard].sort(() => Math.random() - 0.5);
                    setDeck(newDeck);
                    setDiscard([]);
                    setMsg("ç‰Œåº«é‡æ´—ï¼");
                    setTimeout(() => drawCard(n), 500);
                    return;
                }
                const drawn = deck.slice(0, n);
                setHand(h => [...h, ...drawn]);
                setDeck(d => d.slice(n));
            };

            // æµ®å‹•æ–‡å­—
            const showFloater = (text, type, isPlayerTarget = false) => {
                const color = type === 'dmg' ? 'text-red-600' : type === 'heal' ? 'text-green-500' : 'text-yellow-500';
                const target = isPlayerTarget ? 'player' : 'enemy';
                setFloater({ text, color, target });
                setTimeout(() => setFloater(null), 1200);
            };

            // --- ç©å®¶è¡Œå‹• ---

            // 1. é™„èƒ½é‡
            const attachEnergy = (cardIdx) => {
                if (turn !== 'player' || energyAttached) return;
                
                setActivePkmn(p => ({ ...p, energy: p.energy + 1 }));
                
                const card = hand[cardIdx];
                setDiscard(d => [...d, card]);
                setHand(h => h.filter((_, i) => i !== cardIdx));
                
                setEnergyAttached(true);
                showFloater("+1 èƒ½é‡", "buff", true);
                setMsg(`ç‚º ${activePkmn.name} å……èƒ½ï¼`);
            };

            // 2. æ”¾ç½®å¯¶å¯å¤¢åˆ°å‚™æˆ°å€
            const playPokemon = (cardIdx) => {
                if (turn !== 'player') return;
                if (bench.length >= 5) {
                    setMsg("å‚™æˆ°å€å·²æ»¿ï¼");
                    return;
                }

                const card = hand[cardIdx];
                const proto = POKEMON_DB[card.protoId];
                const newPkmn = { ...proto, currentHp: proto.maxHp, energy: 0, instanceId: Date.now() + Math.random() };
                
                setBench(b => [...b, newPkmn]);
                setHand(h => h.filter((_, i) => i !== cardIdx));
                setMsg(`${newPkmn.name} é€²å…¥å‚™æˆ°å€ï¼`);
            };

            // 3. ä½¿ç”¨ç‰©å“/æ”¯æ´è€…
            const playTrainer = (cardIdx) => {
                if (turn !== 'player') return;
                const card = hand[cardIdx];

                if (card.type === 'supporter' && supporterUsed) {
                    setMsg("æ¯å›åˆåªèƒ½ç”¨ä¸€å¼µæ”¯æ´è€…ï¼");
                    return;
                }

                let used = true;
                if (card.effect === 'potion') {
                    setActivePkmn(p => ({ ...p, currentHp: Math.min(p.maxHp, p.currentHp + card.val) }));
                    showFloater(`+${card.val}`, 'heal', true);
                } else if (card.effect === 'switch') {
                    if (bench.length === 0) {
                        setMsg("æ²’æœ‰å‚™æˆ°å¯¶å¯å¤¢ï¼");
                        used = false;
                    } else {
                        setMsg("è«‹é»æ“Šå‚™æˆ°å€çš„å¯¶å¯å¤¢é€²è¡Œäº¤æ›ï¼");
                        swapPokemon(0); // ç°¡æ˜“ç‰ˆç›´æ¥æ›
                    }
                } else if (card.effect === 'research') {
                    setDiscard(d => [...d, ...hand.filter((_, i) => i !== cardIdx)]);
                    setHand([]); 
                    drawCard(card.val);
                } else if (card.effect === 'boss') {
                    setEnemyHp(h => Math.max(0, h - card.val));
                    showFloater(`-${card.val}`, 'dmg', false);
                    drawCard(1);
                } else if (card.effect === 'ball') {
                    // å…ˆæ©Ÿçƒé‚è¼¯ï¼šæ‰¾ç¬¬ä¸€å¼µå¯¶å¯å¤¢
                    const pkmnIdx = deck.findIndex(c => c.type === 'pokemon');
                    if (pkmnIdx >= 0) {
                        const pkmnCard = deck[pkmnIdx];
                        setHand(h => [...h, pkmnCard]);
                        setDeck(d => {
                            const newD = d.filter((_, i) => i !== pkmnIdx);
                            return newD.sort(() => Math.random() - 0.5); // é‡æ–°æ´—ç‰Œ
                        });
                        setMsg(`æŠ½åˆ°äº† ${POKEMON_DB[pkmnCard.protoId].name}ï¼`);
                    } else {
                        setMsg("ç‰Œåº«ä¸­æ²’æœ‰å¯¶å¯å¤¢äº†ï¼");
                    }
                }

                if (used) {
                    setDiscard(d => [...d, card]);
                    setHand(h => h.filter((_, i) => i !== cardIdx));
                    if (card.type === 'supporter') setSupporterUsed(true);
                }
            };

            // äº¤æ›å¯¶å¯å¤¢
            const swapPokemon = (benchIdx) => {
                if (benchIdx < 0 || benchIdx >= bench.length) return;
                
                const newActive = bench[benchIdx];
                const oldActive = activePkmn;
                
                setActivePkmn(newActive);
                setBench(b => {
                    const newB = [...b];
                    newB[benchIdx] = oldActive;
                    return newB;
                });
                
                setMsg(`${newActive.name} ä¸Šå ´äº†ï¼`);
            };

            // 4. æ”»æ“Š
            const attack = (move) => {
                if (turn !== 'player') return;
                if (activePkmn.energy < move.cost) {
                    setMsg("èƒ½é‡ä¸è¶³ï¼");
                    return;
                }

                // è¨ˆç®—å‚·å®³ (å±¬æ€§ç›¸å‰‹)
                const enemyType = ENEMIES[enemyIdx].type;
                const enemyWeakness = ENEMIES[enemyIdx].weakness;
                
                let damage = move.dmg;
                let isSuperEffective = false;

                if (activePkmn.type === enemyWeakness) {
                    damage *= 2;
                    isSuperEffective = true;
                }

                // åŸ·è¡Œæ”»æ“Š
                setPAnim('attack-anim-right');
                setTimeout(() => setPAnim(''), 300);
                setTimeout(() => {
                    setEAnim('shake');
                    setEnemyHp(h => Math.max(0, h - damage));
                    showFloater(isSuperEffective ? `-${damage} (æ•ˆæœçµ•ä½³!)` : `-${damage}`, 'dmg', false);
                }, 150);

                setMsg(`${activePkmn.name} ä½¿ç”¨äº† ${move.name}ï¼`);
                setTip(move.tip); // é¡¯ç¤ºè¡›æ•™

                // åˆ¤å®šå‹åˆ©
                if (enemyHp - damage <= 0) {
                    setTimeout(handleWin, 1500);
                    return;
                }

                setTimeout(endTurn, 2000);
            };

            const endTurn = () => {
                setTurn('enemy');
                setMsg("å°æ‰‹å›åˆ...");
                setTip(null);
                setTimeout(enemyAction, 1500);
            };

            const enemyAction = () => {
                const enemyProto = ENEMIES[enemyIdx];
                const move = enemyNextMove;
                
                setEAnim('attack-anim-left');
                setTimeout(() => setEAnim(''), 300);

                setTimeout(() => {
                    const dmg = move.dmg || 0;
                    if (dmg > 0) {
                        setActivePkmn(p => ({ ...p, currentHp: Math.max(0, p.currentHp - dmg) }));
                        setPAnim('shake');
                        showFloater(`-${dmg}`, 'dmg', true);
                    }
                }, 150);

                setMsg(`${enemyProto.name} ä½¿ç”¨äº† ${move.name}ï¼`);

                // åˆ¤å®šç©å®¶æ°£çµ•
                if (activePkmn.currentHp - (move.dmg || 0) <= 0) {
                    setTimeout(handleFaint, 1500);
                    return;
                }

                // æº–å‚™ä¸‹å›åˆ
                setTimeout(() => {
                    setTurn('player');
                    setEnergyAttached(false);
                    setSupporterUsed(false);
                    setMsg("ä½ çš„å›åˆï¼æŠ½ 1 å¼µå¡ã€‚");
                    drawCard(1);
                    // æ•µäººä¸‹å›åˆå‹•ä½œ
                    const nextMove = enemyProto.moves[Math.floor(Math.random() * enemyProto.moves.length)];
                    setEnemyNextMove(nextMove);
                }, 2000);
            };

            const handleFaint = () => {
                if (bench.length > 0) {
                    setMsg(`${activePkmn.name} å€’ä¸‹äº†ï¼è‡ªå‹•äº¤æ›...`);
                    setTimeout(() => {
                        swapPokemon(0);
                        setTurn('player');
                        setEnergyAttached(false); 
                        setSupporterUsed(false);
                        drawCard(1);
                    }, 2000);
                } else {
                    setScene('lose');
                }
            };

            const handleWin = () => {
                if (enemyIdx < ENEMIES.length - 1) {
                    setEnemyIdx(i => i + 1);
                    setScene('level_clear');
                } else {
                    setScene('win');
                }
            };

            // --- æ¸²æŸ“ ---

            if (scene === 'menu') {
                return (
                    <div className="h-full flex flex-col items-center justify-center battle-bg">
                        <div className="bg-white/90 p-10 rounded-3xl shadow-2xl text-center border-4 border-yellow-400 max-w-md mx-4">
                            <h1 className="text-4xl font-bold text-slate-800 mb-2">å¯¶å¯å¤¢å¥åº·å¤§æˆ°</h1>
                            <div className="text-sm font-bold bg-yellow-400 text-yellow-900 inline-block px-3 py-1 rounded-full mb-6">PTCG å®Œæ•´è¦å‰‡ç‰ˆ</div>
                            
                            <div className="flex justify-center gap-4 mb-8">
                                <img src={POKEMON_DB.machamp.img} className="w-20 h-20 animate-bounce" />
                                <img src={POKEMON_DB.lucario.img} className="w-20 h-20 animate-bounce delay-100" />
                                <img src={POKEMON_DB.cinderace.img} className="w-20 h-20 animate-bounce delay-200" />
                            </div>

                            <p className="text-slate-600 mb-8 text-sm text-left bg-slate-100 p-4 rounded-lg">
                                ğŸ’¡ æ–°å¢æ©Ÿåˆ¶ï¼š<br/>
                                1. <b>å‚™æˆ°å€</b>ï¼šæŠ½å¡ç²å¾—æ–°å¤¥ä¼´ï¼Œéš¨æ™‚äº¤æ›æˆ°è¡“ã€‚<br/>
                                2. <b>å±¬æ€§ç›¸å‰‹</b>ï¼šæ ¼é¬¥å‰‹ä¸€èˆ¬ï¼Œæ°´å‰‹ç³–åˆ†ï¼<br/>
                                3. <b>å…ˆæ©Ÿçƒ</b>ï¼šä½¿ç”¨ç‰©å“å¡ç›´æ¥æœå°‹å¤¥ä¼´ï¼
                            </p>

                            <button onClick={initGame} className="w-full bg-red-600 hover:bg-red-700 text-white text-xl font-bold py-4 px-8 rounded-2xl shadow-lg transition transform hover:scale-105">
                                é–‹å§‹å†’éšª
                            </button>
                        </div>
                    </div>
                );
            }

            if (scene === 'level_clear') {
                return (
                    <div className="h-full flex flex-col items-center justify-center bg-green-100">
                        <div className="text-center animate-bounce">
                            <h2 className="text-4xl font-bold text-green-700 mb-4">å‹åˆ©ï¼</h2>
                            <p className="text-xl mb-8">éšŠä¼ä¼‘æ¯ä¸­... HP å·²æ¢å¾©ï¼</p>
                            <button onClick={() => startLevel(enemyIdx)} className="bg-blue-600 text-white font-bold py-3 px-10 rounded-full shadow-lg hover:scale-105 transition">
                                æŒ‘æˆ°ä¸‹ä¸€é—œ
                            </button>
                        </div>
                    </div>
                );
            }

            if (scene === 'win' || scene === 'lose') {
                return (
                    <div className={`h-full flex flex-col items-center justify-center ${scene === 'win' ? 'bg-yellow-100' : 'bg-slate-800 text-white'}`}>
                        <h2 className="text-5xl font-bold mb-6">{scene === 'win' ? 'å®Œå…¨å‹åˆ©ï¼' : 'æŒ‘æˆ°å¤±æ•—...'}</h2>
                        <button onClick={() => setScene('menu')} className="bg-white text-slate-800 font-bold py-3 px-8 rounded-full shadow-lg">å›ä¸»é¸å–®</button>
                    </div>
                );
            }

            const enemyProto = ENEMIES[enemyIdx];

            return (
                <div className="h-full flex flex-col relative battle-bg">
                    
                    {/* æµ®å‹•æ–‡å­— */}
                    {floater && (
                        <div className={`absolute z-50 text-4xl font-black damage-pop ${floater.color}`}
                             style={{ top: floater.target === 'enemy' ? '25%' : '50%', left: '50%' }}>
                            {floater.text}
                        </div>
                    )}

                    {/* è¡›æ•™æç¤ºçª— (å³ä¸Šè§’) */}
                    {tip && (
                        <div className="absolute top-4 right-4 z-40 max-w-xs bg-yellow-50 border-l-4 border-yellow-500 p-4 shadow-lg rounded tip-box">
                            <div className="flex items-start">
                                <span className="text-2xl mr-2">ğŸ’¡</span>
                                <div>
                                    <h4 className="font-bold text-yellow-800 text-xs uppercase mb-1">Health Tip</h4>
                                    <p className="text-sm text-slate-700 leading-tight">{tip}</p>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- æˆ°å ´å€ --- */}
                    <div className="flex-1 flex flex-col relative">
                        
                        {/* æ•µäººå€åŸŸ */}
                        <div className="flex-1 flex items-center justify-center relative">
                            <div className={`relative flex flex-col items-center ${eAnim}`}>
                                <img src={enemyProto.img} className="w-40 h-40 md:w-56 md:h-56 drop-shadow-xl z-10" />
                                <div className="bg-slate-800/80 text-white px-4 py-2 rounded-xl mt-[-20px] z-20 text-center min-w-[160px]">
                                    <div className="flex justify-between items-center text-sm mb-1">
                                        <span className="font-bold">{enemyProto.name}</span>
                                        <TypeBadge type={enemyProto.type} />
                                    </div>
                                    <div className="w-full bg-slate-600 h-2 rounded-full overflow-hidden">
                                        <div className="bg-red-500 h-full transition-all duration-300" style={{width: `${(enemyHp/enemyProto.maxHp)*100}%`}}></div>
                                    </div>
                                    <div className="text-xs mt-1 text-slate-400">å¼±é»: {ENEMIES[enemyIdx].weakness === 'fighting' ? 'æ ¼é¬¥' : 'æ°´'}</div>
                                </div>
                            </div>
                        </div>

                        {/* ç©å®¶å€åŸŸ (Active + Bench) */}
                        <div className="flex-1 flex items-center justify-center relative px-4">
                            
                            {/* Active Pokemon */}
                            <div className={`relative flex flex-col items-center mr-8 ${pAnim}`}>
                                <img src={activePkmn.img} className="w-48 h-48 md:w-64 md:h-64 drop-shadow-2xl z-10" />
                                <div className="bg-white/90 text-slate-800 px-4 py-3 rounded-xl border-2 border-slate-200 mt-[-40px] z-20 min-w-[200px] shadow-lg">
                                    <div className="flex justify-between items-center mb-1">
                                        <span className="font-bold text-lg">{activePkmn.name}</span>
                                        <TypeBadge type={activePkmn.type} />
                                    </div>
                                    <div className="w-full bg-slate-200 h-3 rounded-full overflow-hidden mb-1">
                                        <div className="bg-green-500 h-full transition-all duration-300" style={{width: `${(activePkmn.currentHp/activePkmn.maxHp)*100}%`}}></div>
                                    </div>
                                    <div className="flex justify-between text-xs font-bold text-slate-500">
                                        <span>HP: {activePkmn.currentHp}</span>
                                        <span>èƒ½é‡: {activePkmn.energy}âš¡</span>
                                    </div>
                                </div>
                            </div>

                            {/* æ‹›å¼é¸å–® */}
                            <div className="flex flex-col gap-2 z-20">
                                {activePkmn.moves.map((move, i) => (
                                    <button 
                                        key={i}
                                        onClick={() => attack(move)}
                                        disabled={turn !== 'player' || activePkmn.energy < move.cost}
                                        className={`
                                            px-4 py-3 rounded-lg border-l-4 shadow-md text-left transition-all min-w-[180px]
                                            ${activePkmn.energy >= move.cost 
                                                ? 'bg-white border-red-500 hover:bg-red-50 hover:translate-x-2' 
                                                : 'bg-slate-200 border-slate-400 opacity-60 cursor-not-allowed'}
                                        `}
                                    >
                                        <div className="flex justify-between font-bold text-slate-800">
                                            <span>{move.name}</span>
                                            <span>{move.dmg}</span>
                                        </div>
                                        <div className="text-xs text-slate-500">
                                            éœ€ {move.cost} èƒ½é‡
                                        </div>
                                    </button>
                                ))}
                                
                                {/* å‚™æˆ°å€é¡¯ç¤º (ç°¡æ˜“ç‰ˆ) */}
                                <div className="mt-4">
                                    <div className="text-xs font-bold text-slate-500 mb-1">å‚™æˆ°å€ (é»æ“Šäº¤æ›):</div>
                                    <div className="flex gap-2">
                                        {bench.map((p, i) => (
                                            <div 
                                                key={p.instanceId} 
                                                onClick={() => turn === 'player' && swapPokemon(i)}
                                                className="w-12 h-12 rounded-full border-2 border-white bg-slate-300 overflow-hidden cursor-pointer hover:scale-110 transition shadow-md relative group"
                                            >
                                                <img src={p.img} className="w-full h-full object-cover" />
                                                {/* Tooltip */}
                                                <div className="absolute bottom-full left-1/2 -translate-x-1/2 bg-black text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 pointer-events-none whitespace-nowrap">
                                                    {p.name} (HP:{p.currentHp})
                                                </div>
                                            </div>
                                        ))}
                                        {[...Array(5 - bench.length)].map((_, i) => (
                                            <div key={i} className="w-12 h-12 rounded-full border-2 border-dashed border-slate-400 bg-transparent opacity-30"></div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    {/* --- æ‰‹ç‰Œå€ --- */}
                    <div className="h-48 bg-slate-800/90 backdrop-blur border-t border-slate-600 flex flex-col z-30">
                        <div className="px-4 py-1 flex justify-between items-center text-xs text-slate-300 bg-black/20">
                            <div>è¨Šæ¯: <span className="text-yellow-400 font-bold">{msg}</span></div>
                            <div className="flex gap-4">
                                <span>ç‰Œåº«: {deck.length}</span>
                                <button onClick={endTurn} disabled={turn !== 'player'} className="bg-yellow-600 hover:bg-yellow-500 text-white px-3 py-0.5 rounded disabled:opacity-50">çµæŸå›åˆ</button>
                            </div>
                        </div>
                        <div className="flex-1 flex items-center gap-2 px-4 overflow-x-auto no-scrollbar py-2">
                            {hand.map((card, i) => (
                                <div 
                                    key={i}
                                    onClick={() => {
                                        if (card.type === 'energy') attachEnergy(i);
                                        else if (card.type === 'pokemon') playPokemon(i);
                                        else playTrainer(i);
                                    }}
                                    className={`
                                        flex-shrink-0 w-24 h-36 rounded border-2 border-slate-600 relative cursor-pointer card-shadow bg-slate-700 text-white p-2 flex flex-col
                                        ${card.type === 'energy' ? 'border-orange-500' : card.type === 'pokemon' ? 'border-green-500' : 'border-blue-500'}
                                        hover:-translate-y-4 transition-transform
                                    `}
                                >
                                    <div className="text-[10px] opacity-70 mb-1">
                                        {card.type === 'energy' ? 'èƒ½é‡' : card.type === 'pokemon' ? 'åŸºç¤' : 'è¨“ç·´å®¶'}
                                    </div>
                                    <div className="font-bold text-sm leading-tight mb-auto">
                                        {card.name || POKEMON_DB[card.protoId].name}
                                    </div>
                                    
                                    {/* å¡é¢åœ–ç¤º */}
                                    <div className="self-center my-1 text-2xl">
                                        {card.type === 'pokemon' 
                                            ? <img src={POKEMON_DB[card.protoId].img} className="w-12 h-12" /> 
                                            : card.type === 'energy' ? 'âš¡' : 'ğŸ’'}
                                    </div>

                                    <div className="text-[9px] leading-tight opacity-80 overflow-hidden h-8">
                                        {card.desc || `${POKEMON_DB[card.protoId].type === 'fighting' ? 'æ ¼é¬¥' : POKEMON_DB[card.protoId].type === 'water' ? 'æ°´' : 'ç«'}å±¬æ€§ HP${POKEMON_DB[card.protoId].maxHp}`}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
