<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¶å¯å¤¢å¥åº·å¤§æˆ° (PTCGè¦å‰‡ç‰ˆ)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        
        /* æˆ°é¬¥èƒŒæ™¯ */
        .battle-bg {
            background: radial-gradient(circle at center, #ffffff 0%, #f0f9ff 40%, #bae6fd 100%);
            background-size: cover;
        }

        /* å¡ç‰Œæ¨£å¼ */
        .card-shadow {
            box-shadow: 2px 4px 10px rgba(0,0,0,0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card-shadow:hover {
            transform: translateY(-15px); /* å¢åŠ æ‡¸æµ®é«˜åº¦ */
            box-shadow: 4px 8px 15px rgba(0,0,0,0.4);
            z-index: 50; /* ç¢ºä¿æ‡¸æµ®æ™‚åœ¨æœ€ä¸Šå±¤ */
        }

        /* å‹•ç•« */
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-2px, 0, 0); }
            20%, 80% { transform: translate3d(4px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-8px, 0, 0); }
            40%, 60% { transform: translate3d(8px, 0, 0); }
        }

        .pop-text {
            animation: popUp 1.2s forwards;
            pointer-events: none;
            text-shadow: 2px 2px 0px white, -1px -1px 0px white, 1px -1px 0px white, -1px 1px 0px white, 1px 1px 0px white;
        }
        @keyframes popUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-100px) scale(1.5); }
        }

        .player-attack { animation: lungeRight 0.3s forwards; }
        @keyframes lungeRight {
            0% { transform: translateX(0); }
            50% { transform: translateX(50px); }
            100% { transform: translateX(0); }
        }

        .enemy-attack { animation: lungeLeft 0.3s forwards; }
        @keyframes lungeLeft {
            0% { transform: translateX(0); }
            50% { transform: translateX(-50px); }
            100% { transform: translateX(0); }
        }
        
        /* è¡›æ•™è³‡è¨Šå½ˆçª—å‹•ç•« */
        .tip-slide-in {
            animation: slideIn 0.5s ease-out forwards;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* èƒ½é‡çƒæ¨£å¼ */
        .energy-orb {
            box-shadow: inset -2px -2px 6px rgba(0,0,0,0.3);
        }

        /* æ»¾å‹•æ¢éš±è— */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="h-screen overflow-hidden select-none bg-slate-800">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- åœ–ç‰‡è³‡æº ---
        const IMG_PLAYER = "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/68.png"; // æ€ªåŠ›
        
        // --- æ•µäººè³‡æ–™åº« (å£ç¿’æ…£è»åœ˜) ---
        const ENEMIES = [
            {
                id: 'sedentary',
                name: "è«‹å‡ç‹",
                title: "ä¹…åé­”äºº",
                img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/289.png",
                maxHp: 120,
                desc: "é•·æ™‚é–“åè‘—ä¸å‹•ï¼Œä»£è¬è®Šæ…¢äº†...",
                tips: "æ¯å30åˆ†é˜ï¼Œè¨˜å¾—èµ·ä¾†æ´»å‹•3åˆ†é˜ï¼",
                moves: [
                    { name: "æ‡¶æƒ°ç¿»èº«", dmg: 10, text: "è«‹å‡ç‹ç¿»äº†å€‹èº«ï¼Œå®Œå…¨ä¸æƒ³å‹•ã€‚" },
                    { name: "ä¹…åé‡å£“", dmg: 30, text: "é•·æ™‚é–“ä¹…åçš„å£“åŠ›è¥²ä¾†ï¼è…°ç— èƒŒç—›ï¼" }
                ]
            },
            {
                id: 'junkfood',
                name: "è—é£½æ —é¼ ",
                title: "é›¶é£Ÿå›¤ç©è€…",
                img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/820.png",
                maxHp: 150,
                desc: "è‚šå­è£¡å¡æ»¿äº†é«˜ç†±é‡çš„æ´‹èŠ‹ç‰‡å’Œç‚¸é›ã€‚",
                tips: "å°‘åƒåŠ å·¥é£Ÿå“ï¼Œå¤šåƒåŸå‹é£Ÿç‰©(å¦‚åœ°ç“œã€ç³™ç±³)ï¼",
                moves: [
                    { name: "å¡æ»¿å˜´", dmg: 20, heal: 20, text: "è—é£½æ —é¼ åƒäº†ä¸€å †é›¶é£Ÿï¼Œæ¢å¾©äº†é«”åŠ›ï¼" },
                    { name: "æ²¹è„‚å™´å°„", dmg: 40, text: "é«˜æ²¹è„‚æ”»æ“Šï¼è¡€ç®¡è² æ“”åŠ é‡ï¼" }
                ]
            },
            {
                id: 'sugary',
                name: "æ€–æ€å£º",
                title: "ç³–åˆ†å¹½éˆ",
                img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/855.png",
                maxHp: 140,
                desc: "ç”œè†©è†©çš„æ‰‹æ–é£²åŒ–èº«ï¼Œå°å¿ƒç³–å°¿ç—…é¢¨éšªã€‚",
                tips: "ä¸–ç•Œè¡›ç”Ÿçµ„ç¹”å»ºè­°ï¼šæ¯æ—¥æ·»åŠ ç³–æ”å–é‡æ‡‰ä½æ–¼ç¸½ç†±é‡çš„10%ï¼",
                moves: [
                    { name: "å…¨ç³–è¡æ“Š", dmg: 35, text: "ç³–åˆ†éé‡ï¼è¡€ç³–é£†å‡ï¼" },
                    { name: "çç çª’æ¯", dmg: 25, text: "å–å¤ªå¤šæ–™äº†ï¼Œæ¶ˆåŒ–ä¸è‰¯ï¼" }
                ]
            },
            {
                id: 'boss',
                name: "å¡æ¯”ç¸",
                title: "ä»£è¬ç—‡å€™ç¾¤",
                img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/143.png",
                maxHp: 200,
                desc: "ä¸æ„›åƒèœã€ä¸é‹å‹•ã€æ„›ç†¬å¤œçš„æœ€çµ‚å‹æ…‹ã€‚",
                tips: "å¤©å¤©äº”è”¬æœï¼Œç™Œç—‡é é›¢æˆ‘ï¼è”¬èœå«æœ‰è±å¯Œè†³é£Ÿçº–ç¶­ã€‚",
                moves: [
                    { name: "æ³°å±±å£“é ‚", dmg: 50, text: "è‚¥èƒ–çš„é‡é‡å£“éä¾†äº†ï¼" },
                    { name: "æš´é£²æš´é£Ÿ", dmg: 30, heal: 30, text: "å¡æ¯”ç¸å¤§åƒå¤§å–ï¼Œé«”é‡åˆå¢åŠ äº†ï¼" },
                    { name: "ç†¬å¤œæ‰“å‘¼", dmg: 20, text: "ç¡çœ å“è³ªæ¥µå·®ï¼Œç²¾ç¥å—æï¼" }
                ]
            }
        ];
        
        // --- éŠæˆ²å¸¸æ•¸ ---
        const MAX_HP_PLAYER = 180; // æ€ªåŠ› HP æå‡ä¸€é»ä»¥æ‡‰å°é€£æˆ°
        
        // --- æ€ªåŠ› (ç©å®¶) çš„æ‹›å¼è¡¨ (éæ‰‹ç‰Œ) + è¡›æ•™è³‡è¨Š ---
        const PLAYER_MOVES = [
            { 
                id: 'm1', name: "ä½ç©ºè¸¢", damage: 30, cost: 1, 
                desc: "è¸¢æ“Šå°æ‰‹è†è“‹ã€‚é€ æˆ30é»å‚·å®³ã€‚",
                tip: "ä¹…åæœƒè®“ä¸‹è‚¢è¡€æ¶²å¾ªç’°è®Šå·®ï¼Œå¤šè¸¢è…¿ä¼¸å±•æœ‰åŠ©æ–¼æ¶ˆæ°´è…«ï¼"
            },
            { 
                id: 'm2', name: "å€ŸåŠ›æ‘”", damage: 60, cost: 2, 
                desc: "åˆ©ç”¨å°æ‰‹çš„åŠ›é‡ã€‚é€ æˆ60é»å‚·å®³ã€‚",
                tip: "æ ¸å¿ƒè‚Œç¾¤æœ‰åŠ›ï¼Œæ‰èƒ½ä¿è­·è„Šæ¤ï¼Œé é›¢è…°ç— èƒŒç—›ï¼"
            },
            { 
                id: 'm3', name: "æ¥µå·¨å¥åº·æ‹³", damage: 100, cost: 3, 
                desc: "å¼·å¤§çš„å¥åº·ä¸€æ“Šï¼é€ æˆ100é»å‚·å®³ï¼Œæ¢å¾©è‡ªå·±20é»HPã€‚", heal: 20,
                tip: "è¦å¾‹é‹å‹•åŠ ä¸Šå‡è¡¡é£²é£Ÿï¼Œæ˜¯æ“Šæ•—ä»£è¬ç—‡å€™ç¾¤çš„æœ€å¼·æ­¦å™¨ï¼"
            }
        ];

        // --- å¡ç‰Œå®šç¾© (æ‰‹ç‰Œ) ---
        const DECK_TEMPLATE = [
            // 15å¼µèƒ½é‡å¡
            ...Array(15).fill({ type: 'energy', name: "é¬¥èƒ½é‡", desc: "é™„è‘—æ–¼å¯¶å¯å¤¢èº«ä¸Šä»¥ä½¿ç”¨æ‹›å¼ã€‚", color: "bg-orange-600" }),
            // ç‰©å“å¡
            ...Array(4).fill({ type: 'item', id: 'potion', name: "å‚·è—¥", desc: "æ¢å¾©30é»HPã€‚", color: "bg-blue-500", effect: 'heal', val: 30 }),
            ...Array(2).fill({ type: 'item', id: 'cycling', name: "è…³è¸è»Š", desc: "æŠ½1å¼µå¡ã€‚", color: "bg-blue-500", effect: 'draw', val: 1 }),
            ...Array(2).fill({ type: 'item', id: 'dumbbell', name: "å•éˆ´", desc: "æœ¬å›åˆå‚·å®³+20ã€‚", color: "bg-blue-500", effect: 'buff_dmg', val: 20 }),
            // æ”¯æ´è€…å¡
            ...Array(3).fill({ type: 'supporter', id: 'research', name: "åšå£«çš„ç ”ç©¶", desc: "ä¸Ÿæ£„æ‰‹ç‰Œ(éŠæˆ²ä¸­ä¸ä¸Ÿ)ï¼ŒæŠ½3å¼µã€‚", color: "bg-red-500", effect: 'draw', val: 3 }),
            ...Array(2).fill({ type: 'supporter', id: 'nurse', name: "å–¬ä¼Šå°å§", desc: "HPæ¢å¾©60é»ã€‚", color: "bg-red-500", effect: 'heal', val: 60 }),
            ...Array(2).fill({ type: 'supporter', id: 'boss', name: "è€å¤§çš„æŒ‡ä»¤", desc: "é€ æˆå°æ‰‹20é»å‚·å®³ä¸¦æŠ½1å¼µã€‚", color: "bg-red-500", effect: 'attack_draw', val: 20 }),
        ];

        const App = () => {
            // å ´æ™¯: menu, battle, win, lose, stage_clear
            const [scene, setScene] = useState('menu'); 
            
            // éŠæˆ²é€²åº¦
            const [currentEnemyIndex, setCurrentEnemyIndex] = useState(0);
            const enemy = ENEMIES[currentEnemyIndex];

            // ç©å®¶ç‹€æ…‹
            const [pHP, setPHP] = useState(MAX_HP_PLAYER);
            const [pEnergy, setPEnergy] = useState(0);
            const [hand, setHand] = useState([]);
            const [deck, setDeck] = useState([]);
            const [discardPile, setDiscardPile] = useState(0);
            
            // å›åˆç‹€æ…‹
            const [turn, setTurn] = useState('player'); 
            const [energyAttachedThisTurn, setEnergyAttachedThisTurn] = useState(false);
            const [supporterUsedThisTurn, setSupporterUsedThisTurn] = useState(false);
            const [damageBuff, setDamageBuff] = useState(0);
            
            // æ•µäººç‹€æ…‹
            const [eHP, setEHP] = useState(enemy.maxHp);
            const [enemyNextMove, setEnemyNextMove] = useState(null);

            // UI & å‹•ç•«ç‹€æ…‹
            const [msg, setMsg] = useState("");
            const [floater, setFloater] = useState(null); 
            const [pAnim, setPAnim] = useState('');
            const [eAnim, setEAnim] = useState('');
            const [activeTip, setActiveTip] = useState(null); // é¡¯ç¤ºçš„è¡›æ•™è³‡è¨Š

            // åˆå§‹åŒ–æˆ°é¬¥ (å…¨é‡ç½®)
            const startNewGame = () => {
                setCurrentEnemyIndex(0);
                startLevel(0, true);
            };

            // é–‹å§‹é—œå¡ (ä¿ç•™ç©å®¶éƒ¨åˆ†ç‹€æ…‹å¦‚æœæ˜¯ä¸‹ä¸€é—œ)
            const startLevel = (enemyIndex, fullReset = false) => {
                const newEnemy = ENEMIES[enemyIndex];
                
                if (fullReset) {
                    setPHP(MAX_HP_PLAYER);
                    const newDeck = [...DECK_TEMPLATE].sort(() => Math.random() - 0.5);
                    setHand(newDeck.slice(0, 7));
                    setDeck(newDeck.slice(7));
                    setPEnergy(0);
                    setDiscardPile(0);
                } else {
                    // ä¸‹ä¸€é—œçå‹µï¼šè£œæ»¿è¡€ã€è£œæ‰‹ç‰Œ
                    setPHP(MAX_HP_PLAYER); 
                    const cardsNeeded = 7 - hand.length;
                    if (cardsNeeded > 0) {
                        drawCard(cardsNeeded);
                    }
                }

                setEHP(newEnemy.maxHp);
                setTurn('player');
                setMsg(`é­é‡æ•µäººï¼š${newEnemy.name} (${newEnemy.title})ï¼`);
                setEnergyAttachedThisTurn(false);
                setSupporterUsedThisTurn(false);
                setDamageBuff(0);
                setActiveTip(null);
                
                planEnemyAction(newEnemy);
                setScene('battle');
            };

            const planEnemyAction = (targetEnemy = enemy) => {
                const moves = targetEnemy.moves;
                const action = moves[Math.floor(Math.random() * moves.length)];
                setEnemyNextMove(action);
            };

            const drawCard = (count = 1) => {
                let currentDeck = [...deck];
                let currentHand = [...hand];
                
                if (currentDeck.length < count) {
                    // ç°¡å–®æ´—ç‰Œæ©Ÿåˆ¶ï¼šå¦‚æœç‰Œåº«æ²’äº†ï¼Œé‡æ–°ç”Ÿæˆ
                    setMsg("ç‰Œåº«é‡æ´—ä¸­...");
                    currentDeck = [...DECK_TEMPLATE].sort(() => Math.random() - 0.5);
                }

                const draw = currentDeck.slice(0, count);
                const left = currentDeck.slice(count);
                
                setHand([...currentHand, ...draw]);
                setDeck(left);
                return draw.length;
            };

            const showFloater = (text, type) => {
                const color = type === 'damage' ? 'text-red-600' : type === 'heal' ? 'text-green-500' : 'text-blue-500';
                const target = type === 'damage' ? (turn === 'player' ? 'enemy' : 'player') : (turn === 'player' ? 'player' : 'enemy');
                setFloater({ text, color, target });
                setTimeout(() => setFloater(null), 1000);
            };

            // é¡¯ç¤ºè¡›æ•™è³‡è¨Š (3ç§’å¾Œæ¶ˆå¤±)
            const triggerTip = (text) => {
                setActiveTip(text);
                setTimeout(() => setActiveTip(null), 4000);
            };

            // --- ç©å®¶å‹•ä½œ ---

            const attachEnergy = (cardIndex) => {
                if (turn !== 'player') return;
                if (energyAttachedThisTurn) {
                    setMsg("é€™å€‹å›åˆå·²ç¶“é™„è‘—éèƒ½é‡äº†ï¼");
                    return;
                }
                const newHand = [...hand];
                newHand.splice(cardIndex, 1);
                setHand(newHand);
                setPEnergy(prev => prev + 1);
                setEnergyAttachedThisTurn(true);
                setMsg("é™„è‘—èƒ½é‡ï¼æº–å‚™é‹å‹•ï¼");
                showFloater("+1 èƒ½é‡", "buff");
            };

            const playTrainer = (card, index) => {
                if (turn !== 'player') return;
                if (card.type === 'supporter' && supporterUsedThisTurn) {
                    setMsg("æ¯å€‹å›åˆåªèƒ½ä½¿ç”¨ä¸€å¼µæ”¯æ´è€…å¡ï¼");
                    return;
                }
                const newHand = [...hand];
                newHand.splice(index, 1);
                setHand(newHand);
                setDiscardPile(prev => prev + 1);

                let effectMsg = "";
                if (card.type === 'supporter') setSupporterUsedThisTurn(true);

                switch (card.effect) {
                    case 'heal':
                        const healAmount = card.val;
                        setPHP(prev => Math.min(MAX_HP_PLAYER, prev + healAmount));
                        showFloater(`+${healAmount}`, 'heal');
                        effectMsg = `ä½¿ç”¨äº†${card.name}ï¼Œæ¢å¾©é«”åŠ›ï¼`;
                        triggerTip("é©åº¦ä¼‘æ¯å’Œè£œå……ç‡Ÿé¤Šï¼Œèƒ½è®“é‹å‹•è¡¨ç¾æ›´å¥½å–”ï¼");
                        break;
                    case 'draw':
                        const drawn = drawCard(card.val);
                        effectMsg = `ä½¿ç”¨äº†${card.name}ï¼Œå°‹æ‰¾æ–°å°ç­–ï¼`;
                        break;
                    case 'buff_dmg':
                        setDamageBuff(prev => prev + card.val);
                        effectMsg = `ä½¿ç”¨äº†${card.name}ï¼ŒåŠ›é‡æå‡ï¼`;
                        triggerTip("è² é‡è¨“ç·´å¯ä»¥å¢åŠ éª¨è³ªå¯†åº¦å’Œè‚Œè‚‰é‡ï¼");
                        break;
                    case 'attack_draw':
                        setEHP(prev => Math.max(0, prev - card.val));
                        drawCard(1);
                        setEAnim('shake');
                        showFloater(`-${card.val}`, 'damage');
                        effectMsg = `ä½¿ç”¨äº†${card.name}ï¼å¼·åˆ¶æ•µäººé‹å‹•ï¼`;
                        triggerTip("æ‰¾æœ‹å‹ä¸€èµ·é‹å‹•(è€å¤§çš„æŒ‡ä»¤)ï¼Œæ›´æœ‰å‹•åŠ›ç¶­æŒç¿’æ…£ï¼");
                        break;
                    default:
                        effectMsg = `ä½¿ç”¨äº†${card.name}ï¼`;
                }
                setMsg(effectMsg);
            };

            const useMove = (move) => {
                if (turn !== 'player') return;
                if (pEnergy < move.cost) {
                    setMsg("èƒ½é‡ä¸è¶³ï¼");
                    return;
                }

                const totalDamage = move.damage + damageBuff;
                setEHP(prev => Math.max(0, prev - totalDamage));
                
                setPAnim('player-attack');
                setTimeout(() => setPAnim(''), 300);
                setTimeout(() => {
                    setEAnim('shake');
                    showFloater(`-${totalDamage}`, 'damage');
                    setTimeout(() => setEAnim(''), 500);
                }, 150);

                if (move.heal) {
                    setPHP(prev => Math.min(MAX_HP_PLAYER, prev + move.heal));
                    setTimeout(() => showFloater(`+${move.heal}`, 'heal'), 200);
                }

                setMsg(`æ€ªåŠ›ä½¿ç”¨ ${move.name}ï¼`);
                
                // é¡¯ç¤ºè©²æ‹›å¼æˆ–é‡å°ç•¶å‰æ•µäººçš„è¡›æ•™è³‡è¨Š
                // å„ªå…ˆé¡¯ç¤ºæ‹›å¼ç‰¹å®šTipï¼Œå¦‚æœæ²’æœ‰å‰‡é¡¯ç¤ºæ•µäººå¼±é»Tip
                const tipToShow = move.tip || enemy.tips;
                triggerTip(`ğŸ’¡ å¥åº·å°çŸ¥è­˜ï¼š${tipToShow}`);

                if (eHP - totalDamage <= 0) {
                    setTimeout(() => handleWin(), 1000);
                    return;
                }

                setTimeout(endPlayerTurn, 2000); // ç¨å¾®å»¶é•·ä¸€é»æ™‚é–“è®“ç©å®¶çœ‹Tip
            };

            const endPlayerTurn = () => {
                setTurn('enemy');
                setMsg(`${enemy.name} æº–å‚™è¡Œå‹•...`);
                setDamageBuff(0);
                setActiveTip(null);
                setTimeout(enemyAction, 1500);
            };

            const enemyAction = () => {
                const move = enemyNextMove;
                setEAnim('enemy-attack');
                setTimeout(() => setEAnim(''), 300);

                setTimeout(() => {
                    if (move.dmg > 0) {
                        setPHP(prev => Math.max(0, prev - move.dmg));
                        setPAnim('shake');
                        showFloater(`-${move.dmg}`, 'damage');
                        setTimeout(() => setPAnim(''), 500);
                    }
                    if (move.heal) {
                        setEHP(prev => Math.min(enemy.maxHp, prev + move.heal));
                        showFloater(`+${move.heal}`, 'heal');
                    }
                }, 150);

                setMsg(`${enemy.name} ä½¿ç”¨äº† ${move.name}`);

                if (pHP - move.dmg <= 0) {
                    setTimeout(() => setScene('lose'), 1000);
                    return;
                }

                setTimeout(() => {
                    setTurn('player');
                    setEnergyAttachedThisTurn(false);
                    setSupporterUsedThisTurn(false);
                    planEnemyAction();
                    setMsg("ä½ çš„å›åˆï¼æŠ½1å¼µå¡ã€‚");
                    drawCard(1);
                }, 2000);
            };

            const handleWin = () => {
                if (currentEnemyIndex < ENEMIES.length - 1) {
                    setScene('stage_clear');
                } else {
                    setScene('win');
                }
            };

            const nextStage = () => {
                const nextIndex = currentEnemyIndex + 1;
                setCurrentEnemyIndex(nextIndex);
                startLevel(nextIndex, false);
            };

            // --- æ¸²æŸ“çµ„ä»¶ ---
            
            const renderHandCard = (card, index) => {
                const isEnergy = card.type === 'energy';
                const isTrainer = card.type === 'item' || card.type === 'supporter';
                let disabled = turn !== 'player';
                if (isEnergy && energyAttachedThisTurn) disabled = true;
                if (card.type === 'supporter' && supporterUsedThisTurn) disabled = true;

                return (
                    <div 
                        key={`${index}-${card.name}`}
                        onClick={() => {
                            if (disabled) return;
                            if (isEnergy) attachEnergy(index);
                            if (isTrainer) playTrainer(card, index);
                        }}
                        className={`
                            flex-shrink-0 w-24 h-36 md:w-28 md:h-40 rounded-lg border-2 border-white 
                            flex flex-col p-2 relative cursor-pointer card-shadow select-none
                            ${card.color} text-white
                            ${disabled ? 'opacity-50 grayscale cursor-not-allowed' : 'hover:-translate-y-6 transition-all duration-200'}
                        `}
                    >
                        <div className="text-[10px] font-bold mb-1 opacity-80">
                            {isEnergy ? "èƒ½é‡" : card.type === 'item' ? "ç‰©å“" : "æ”¯æ´è€…"}
                        </div>
                        <div className="font-bold text-sm leading-tight mb-2">{card.name}</div>
                        <div className="flex-1 flex items-center justify-center text-2xl">
                            {isEnergy ? "âš¡" : "ğŸ’"}
                        </div>
                        <div className="text-[10px] leading-tight opacity-90">
                            {card.desc}
                        </div>
                    </div>
                );
            };

            // --- ç•«é¢æ¸²æŸ“ ---

            if (scene === 'menu') {
                return (
                    <div className="h-full flex flex-col items-center justify-center battle-bg relative">
                        <div className="bg-white/90 p-8 rounded-2xl shadow-2xl text-center max-w-md mx-4 backdrop-blur-sm border-4 border-yellow-400">
                            <h1 className="text-4xl font-bold text-slate-800 mb-2">å¯¶å¯å¤¢å¥åº·å¤§æˆ°</h1>
                            <p className="text-slate-600 mb-6 font-bold">æ“Šæ•—å£ç¿’æ…£è»åœ˜ï¼</p>
                            <div className="grid grid-cols-4 gap-2 mb-8">
                                {ENEMIES.map((e, i) => (
                                    <div key={e.id} className="flex flex-col items-center">
                                        <img src={e.img} className="w-16 h-16 drop-shadow-md" />
                                        <span className="text-xs font-bold text-slate-500 mt-1">{i+1}.{e.title}</span>
                                    </div>
                                ))}
                            </div>
                            <button 
                                onClick={startNewGame}
                                className="w-full bg-red-600 hover:bg-red-700 text-white text-xl font-bold py-3 px-8 rounded-full shadow-lg transition transform hover:scale-105"
                            >
                                é–‹å§‹æŒ‘æˆ°
                            </button>
                        </div>
                    </div>
                );
            }

            if (scene === 'stage_clear') {
                return (
                    <div className="h-full flex flex-col items-center justify-center battle-bg bg-green-50">
                        <div className="text-center p-8 bg-white rounded-2xl shadow-2xl animate-bounce">
                            <h2 className="text-4xl font-bold text-green-600 mb-4">æŒ‘æˆ°æˆåŠŸï¼</h2>
                            <p className="text-xl text-slate-700 mb-2">ä½ æ“Šæ•—äº† {enemy.name}ï¼</p>
                            <p className="text-md text-slate-500 mb-6">ä¼‘æ¯ä¸€ä¸‹ï¼Œæº–å‚™è¿æ¥ä¸‹ä¸€å€‹æŒ‘æˆ°...</p>
                            <button 
                                onClick={nextStage}
                                className="bg-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg text-xl hover:scale-105 transition"
                            >
                                ä¸‹ä¸€é—œ
                            </button>
                        </div>
                    </div>
                );
            }
            
            if (scene === 'win' || scene === 'lose') {
                 return (
                    <div className={`h-full flex flex-col items-center justify-center p-4 ${scene === 'win' ? 'bg-yellow-100' : 'bg-slate-900'}`}>
                        <h1 className={`text-5xl md:text-6xl font-bold mb-4 ${scene === 'win' ? 'text-yellow-600' : 'text-slate-200'}`}>
                            {scene === 'win' ? 'å®Œå…¨å‹åˆ©ï¼' : 'æ•—åŒ—...'}
                        </h1>
                        <img src={scene === 'win' ? IMG_PLAYER : enemy.img} className="w-48 h-48 mb-8 animate-bounce" />
                        <p className={`text-xl mb-8 font-bold ${scene === 'win' ? 'text-slate-700' : 'text-slate-400'}`}>
                            {scene === 'win' ? 'ä½ æˆåŠŸæˆ°å‹äº†æ‰€æœ‰å£ç¿’æ…£ï¼Œæˆç‚ºå¥åº·å¤§å¸«ï¼' : 'åˆ¥æ”¾æ£„ï¼Œå¥åº·çš„è·¯ä¸Šç¸½æœ‰æŒ«æŠ˜ï¼'}
                        </p>
                        <button 
                            onClick={() => setScene('menu')} 
                            className="bg-white text-slate-800 font-bold py-3 px-8 rounded-full shadow-lg text-xl hover:scale-105 transition"
                        >
                            å›åˆ°ä¸»é¸å–®
                        </button>
                    </div>
                );
            }

            return (
                <div className="h-full flex flex-col battle-bg relative overflow-hidden">
                    
                    {/* è¡›æ•™è³‡è¨Šå½ˆçª— (å³å´æ»‘å…¥) */}
                    {activeTip && (
                        <div className="absolute top-20 right-0 max-w-[80%] md:max-w-sm bg-yellow-100 border-l-4 border-yellow-500 p-4 shadow-xl rounded-l-lg z-50 tip-slide-in flex items-start">
                            <div className="text-3xl mr-3">ğŸ’¡</div>
                            <div>
                                <h4 className="font-bold text-yellow-800 text-sm mb-1">å¥åº·å°çŸ¥è­˜</h4>
                                <p className="text-slate-800 text-sm leading-tight">{activeTip}</p>
                            </div>
                        </div>
                    )}

                    {/* æµ®å‹•æ–‡å­—å±¤ */}
                    {floater && (
                        <div className={`absolute z-50 text-5xl font-black pop-text ${floater.color}`}
                             style={{ 
                                 top: floater.target === 'enemy' ? '25%' : '55%', 
                                 left: '50%', 
                                 transform: 'translate(-50%, -50%)',
                             }}>
                            {floater.text}
                        </div>
                    )}

                    {/* ä¸Šæ–¹å€åŸŸï¼šæ•µäºº (30%) */}
                    <div className="flex-none h-[30%] relative flex items-center justify-center">
                        <div className={`relative transition-transform duration-200 ${eAnim}`}>
                            <img src={enemy.img} className="w-32 h-32 md:w-48 md:h-48 drop-shadow-xl filter brightness-110" alt="æ•µäºº" />
                            {/* æ•µäººè¡€æ¢ */}
                            <div className="absolute -bottom-10 left-1/2 transform -translate-x-1/2 w-56 bg-slate-800/90 rounded-lg p-2 text-white text-center shadow-lg border border-slate-600 z-10">
                                <div className="text-sm font-bold flex justify-between px-2">
                                    <span className="text-red-300">{enemy.title}</span>
                                    <span>Lv.{currentEnemyIndex + 1}</span>
                                </div>
                                <div className="text-lg font-bold mb-1">{enemy.name}</div>
                                <div className="w-full bg-slate-600 h-3 rounded-full overflow-hidden">
                                    <div className="bg-red-500 h-full transition-all duration-500" style={{width: `${(eHP/enemy.maxHp)*100}%`}}></div>
                                </div>
                                <div className="text-xs mt-1 text-slate-300">{eHP}/{enemy.maxHp}</div>
                            </div>
                        </div>
                    </div>

                    {/* è¨Šæ¯æ¬„ */}
                    <div className="flex-none h-[10%] flex items-center justify-center z-20">
                         <div className="bg-slate-900/80 text-white px-6 py-2 rounded-full backdrop-blur-sm border border-slate-500 shadow-lg text-sm md:text-base animate-pulse">
                            {msg}
                        </div>
                    </div>

                    {/* ä¸­é–“å€åŸŸï¼šç©å®¶å¯¶å¯å¤¢ & ç‹€æ…‹ (30%) - ç¨å¾®ç¸®å°é«˜åº¦çµ¦æ‰‹ç‰Œæ›´å¤šç©ºé–“ */}
                    <div className="flex-none h-[30%] relative flex items-center justify-center px-4">
                        <div className="flex w-full max-w-4xl justify-between items-end">
                            
                            {/* ç©å®¶å¯¶å¯å¤¢åœ–æ¡ˆ */}
                            <div className={`relative transition-transform duration-200 ${pAnim}`}>
                                <img src={IMG_PLAYER} className="w-40 h-40 md:w-56 md:h-56 drop-shadow-2xl" alt="ç©å®¶" />
                                
                                {/* ç©å®¶è¡€æ¢èˆ‡èƒ½é‡ */}
                                <div className="absolute -top-16 left-1/2 transform -translate-x-1/2 w-60 bg-white/95 rounded-lg p-3 text-slate-800 shadow-xl border-2 border-slate-200 z-10">
                                    <div className="flex justify-between items-end mb-1">
                                        <span className="font-bold text-lg">æ€ªåŠ› (ä½ )</span>
                                        <span className={`font-bold ${pHP < 50 ? 'text-red-500' : 'text-green-600'}`}>{pHP}/{MAX_HP_PLAYER}</span>
                                    </div>
                                    <div className="w-full bg-slate-300 h-3 rounded-full overflow-hidden mb-2">
                                        <div className="bg-green-500 h-full transition-all duration-500" style={{width: `${(pHP/MAX_HP_PLAYER)*100}%`}}></div>
                                    </div>
                                    <div className="flex items-center gap-1 bg-slate-100 rounded px-2 py-1">
                                        <span className="text-xs font-bold text-slate-500">å·²é™„èƒ½é‡:</span>
                                        <div className="flex gap-1 flex-wrap">
                                            {[...Array(pEnergy)].map((_, i) => (
                                                <span key={i} className="w-4 h-4 rounded-full bg-orange-500 border border-white shadow-sm"></span>
                                            ))}
                                            {pEnergy === 0 && <span className="text-xs text-slate-400">ç„¡</span>}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* æ‹›å¼è¡¨ */}
                            <div className="bg-white/90 p-2 md:p-3 rounded-xl shadow-xl border-2 border-slate-200 w-40 md:w-60 flex flex-col gap-2 mb-2 z-20">
                                <div className="text-xs text-slate-400 font-bold text-center">--- æ‹›å¼åˆ—è¡¨ ---</div>
                                {PLAYER_MOVES.map(move => (
                                    <button 
                                        key={move.id}
                                        onClick={() => useMove(move)}
                                        disabled={turn !== 'player' || pEnergy < move.cost}
                                        className={`
                                            w-full text-left p-2 rounded-lg border transition-all relative overflow-hidden group
                                            ${pEnergy >= move.cost 
                                                ? 'bg-orange-50 hover:bg-orange-100 border-orange-200 cursor-pointer' 
                                                : 'bg-slate-100 border-slate-200 opacity-60 cursor-not-allowed'}
                                        `}
                                    >
                                        <div className="flex justify-between items-center mb-1">
                                            <span className="font-bold text-slate-800 text-sm">{move.name}</span>
                                            <span className="text-sm font-bold text-slate-700">{move.damage}</span>
                                        </div>
                                        <div className="flex items-center gap-1 text-xs text-slate-500">
                                            <div className="flex">
                                                {[...Array(move.cost)].map((_, i) => (
                                                    <span key={i} className="w-3 h-3 rounded-full bg-orange-500 inline-block mr-0.5"></span>
                                                ))}
                                            </div>
                                            <span>èƒ½é‡</span>
                                        </div>
                                    </button>
                                ))}
                                {damageBuff > 0 && (
                                    <div className="text-center text-xs font-bold text-red-500 animate-pulse">
                                        ç›®å‰å‚·å®³ +{damageBuff}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* åº•éƒ¨å€åŸŸï¼šæ‰‹ç‰Œ (30%) - å¢åŠ é«˜åº¦ä¸¦èª¿æ•´Paddingé˜²æ­¢é®æ“‹ */}
                    <div className="flex-none h-[30%] bg-slate-900/60 backdrop-blur-md border-t border-slate-600 flex flex-col relative z-30">
                        
                        {/* è³‡è¨Šåˆ—ï¼šå¢åŠ ä¸Šé‚Šè· */}
                        <div className="flex justify-between items-center px-4 py-2 bg-slate-800/50">
                            <div className="text-xs text-white/90 font-bold flex gap-4">
                                <span>æ‰‹ç‰Œ: {hand.length}</span>
                                <span>ç‰Œåº«: {deck.length}</span>
                                <span>æ£„ç‰Œ: {discardPile}</span>
                            </div>
                            <button 
                                onClick={endPlayerTurn}
                                disabled={turn !== 'player'}
                                className={`
                                    px-4 py-1 rounded text-xs font-bold
                                    ${turn === 'player' ? 'bg-yellow-500 hover:bg-yellow-600 text-slate-900' : 'bg-slate-700 text-slate-400'}
                                `}
                            >
                                çµæŸå›åˆ
                            </button>
                        </div>
                        
                        {/* æ‰‹ç‰Œåˆ—è¡¨ï¼šå¢åŠ é ‚éƒ¨ Padding (pt-4) è®“å¡ç‰‡å¾€ä¸‹ç§»ä¸€é»ï¼Œé¿å…è¢«è³‡è¨Šåˆ—é®ä½ */}
                        <div className="flex-1 flex items-start gap-2 px-4 pt-4 overflow-x-auto no-scrollbar pb-2">
                            {hand.map((card, index) => renderHandCard(card, index))}
                        </div>
                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
