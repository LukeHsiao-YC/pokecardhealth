<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¶å¯å¤¢å¥åº·å¤§æˆ° (é€²åŒ–ç‰ˆ)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        
        .battle-bg {
            background: radial-gradient(circle at center, #f1f5f9 0%, #cbd5e1 100%);
            background-image: 
                linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        /* å±¬æ€§æ¨™ç±¤é¡è‰² */
        .type-fighting { background-color: #C03028; }
        .type-normal { background-color: #A8A77A; }
        .type-water { background-color: #6390F0; }
        .type-fire { background-color: #EE8130; }
        .type-ghost { background-color: #735797; }

        /* å¡ç‰Œäº’å‹• */
        .card-container { transition: transform 0.2s, box-shadow 0.2s; }
        .card-container:hover { transform: translateY(-20px) scale(1.05); z-index: 50; }
        
        /* é€²åŒ–å…‰æ•ˆ */
        .evolve-anim { animation: evolveFlash 0.5s ease-in-out; }
        @keyframes evolveFlash {
            0% { filter: brightness(1); transform: scale(1); }
            50% { filter: brightness(3) blur(2px); transform: scale(1.2); }
            100% { filter: brightness(1); transform: scale(1); }
        }

        /* æ”»æ“Šå‹•ç•« */
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .damage-float { animation: floatUp 1s ease-out forwards; text-shadow: 2px 2px 0 #fff; }
        @keyframes floatUp {
            0% { opacity: 1; transform:translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform:translate(-50%, -150%) scale(1.5); }
        }

        /* éš±è—æ»¾å‹•æ¢ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden select-none bg-slate-900 text-slate-800">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- è³‡æ–™åº« ---

        // å¯¶å¯å¤¢è³‡æ–™ (åŒ…å«åŸºç¤èˆ‡é€²åŒ–å‹æ…‹)
        const POKEMON_DB = {
            // æ ¼é¬¥ç³»é€²åŒ–éˆ
            machop: {
                id: 'machop', name: 'è…•åŠ›', type: 'fighting', stage: 'basic', maxHp: 70,
                img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/66.png",
                retreatCost: 1,
                moves: [{ name: "æ‰‹åˆ€", cost: 1, dmg: 20, tip: "åŸºç¤è‚ŒåŠ›è¨“ç·´ï¼Œé©åˆåˆå­¸è€…ã€‚" }]
            },
            machamp: {
                id: 'machamp', name: 'æ€ªåŠ›', type: 'fighting', stage: 'evolution', evolvesFrom: 'machop', maxHp: 180,
                img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/68.png",
                retreatCost: 2,
                moves: [
                    { name: "æ€ªåŠ›ç„¡é›™", cost: 2, dmg: 60, tip: "é€²éšé‡é‡è¨“ç·´ï¼Œå¤§å¹…æå‡è‚Œè‚‰é‡èˆ‡ä»£è¬ï¼" },
                    { name: "åœ°ç„ç¿»æ»¾", cost: 3, dmg: 120, tip: "æ ¸å¿ƒè‚Œç¾¤çš„çµ‚æ¥µå±•ç¾ï¼Œç‡ƒç‡’è„‚è‚ªæ•ˆæœçµ•ä½³ã€‚" }
                ]
            },
            // æ ¼é¬¥ç³»é€²åŒ–éˆ 2
            riolu: {
                id: 'riolu', name: 'åˆ©æ­è·¯', type: 'fighting', stage: 'basic', maxHp: 60,
                img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/447.png",
                retreatCost: 1,
                moves: [{ name: "é›»å…‰ä¸€é–ƒ", cost: 1, dmg: 10, tip: "æ•æ·åº¦è¨“ç·´ï¼Œä¿æŒèº«é«”éˆæ´»ã€‚" }]
            },
            lucario: {
                id: 'lucario', name: 'è·¯å¡åˆ©æ­', type: 'fighting', stage: 'evolution', evolvesFrom: 'riolu', maxHp: 140,
                img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/448.png",
                retreatCost: 1,
                moves: [
                    { name: "ç™¼å‹", cost: 1, dmg: 40, tip: "å°ˆæ³¨åŠ›èˆ‡å‘¼å¸èª¿ç¯€ï¼Œé¡ä¼¼ç‘œçˆæˆ–å¤ªæ¥µã€‚" },
                    { name: "æ³¢å°å½ˆ", cost: 2, dmg: 90, tip: "é«˜å¼·åº¦é–“æ­‡é‹å‹•(HIIT)ï¼ŒçŸ­æ™‚é–“æå‡å¿ƒè‚ºåŠŸèƒ½ã€‚" }
                ]
            },
            // ç«ç³»é€²åŒ–éˆ (æœ‰æ°§)
            scorbunny: {
                id: 'scorbunny', name: 'ç‚å…”å…’', type: 'fire', stage: 'basic', maxHp: 60,
                img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/813.png",
                retreatCost: 1,
                moves: [{ name: "ç«èŠ±", cost: 1, dmg: 20, tip: "æš–èº«é‹å‹•ï¼Œè®“èº«é«”ç†±èµ·ä¾†ã€‚" }]
            },
            cinderace: {
                id: 'cinderace', name: 'é–ƒç„°ç‹ç‰Œ', type: 'fire', stage: 'evolution', evolvesFrom: 'scorbunny', maxHp: 150,
                img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/815.png",
                retreatCost: 0, // æ’¤é€€å…è²»
                moves: [
                    { name: "ç«ç„°çƒ", cost: 2, dmg: 80, tip: "è¸¢è¶³çƒç­‰åœ˜éšŠé‹å‹•ï¼ŒåŸ¹é¤Šå”èª¿æ€§èˆ‡é«”èƒ½ã€‚" },
                    { name: "æ¥µå·¨ç«çƒ", cost: 3, dmg: 140, tip: "é«˜å¼·åº¦æœ‰æ°§ï¼Œç‡ƒç‡’å…§è‡Ÿè„‚è‚ªï¼" }
                ]
            },
            // æ°´ç³»é€²åŒ–éˆ (ä»£è¬)
            sobble: {
                id: 'sobble', name: 'æ·šçœ¼èœ¥', type: 'water', stage: 'basic', maxHp: 50,
                img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/816.png",
                retreatCost: 1,
                moves: [{ name: "æ°´æ§", cost: 1, dmg: 10, tip: "è¨˜å¾—å¤šå–æ°´ï¼Œä¿ƒé€²èº«é«”å¾ªç’°ã€‚" }]
            },
            inteleon: {
                id: 'inteleon', name: 'åƒé¢é¿å½¹', type: 'water', stage: 'evolution', evolvesFrom: 'sobble', maxHp: 130,
                img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/818.png",
                retreatCost: 1,
                moves: [
                    { name: "ç‹™æ“Š", cost: 1, dmg: 50, tip: "ç²¾æº–æ”å–æ°´åˆ†èˆ‡é›»è§£è³ªï¼Œä¸å–å«ç³–é£²æ–™ã€‚" },
                    { name: "é«˜å£“æ°´ç‚®", cost: 2, dmg: 100, tip: "å¤§é‡æ’æ±—å¾Œçš„æ°´åˆ†è£œå……è‡³é—œé‡è¦ã€‚" }
                ]
            }
        };

        const ENEMIES = [
            { id: 'sedentary', name: "è«‹å‡ç‹", title: "ä¹…åé­”äºº", type: 'normal', maxHp: 200, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/289.png", weakness: 'fighting', moves: [{name:"å“ˆæ¬ ", dmg:20, tip:"ä¹…åæœƒè®“ä¸‹åŠèº«å¾ªç’°è®Šå·®ï¼"}, {name:"å·æ‡¶é‡å£“", dmg:50, tip:"ç¼ºä¹é‹å‹•æœƒå°è‡´è‚Œè‚‰æµå¤±ï¼"}] },
            { id: 'junkfood', name: "è—é£½æ —é¼ ", title: "é›¶é£Ÿå›¤ç©è€…", type: 'normal', maxHp: 220, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/820.png", weakness: 'fighting', moves: [{name:"å¤§å¿«æœµé ¤", dmg:30, tip:"é«˜ç†±é‡é›¶é£Ÿæœƒè½‰åŒ–ç‚ºå…§è‡Ÿè„‚è‚ªã€‚"}, {name:"ç¨®å­æ©Ÿé—œæ§", dmg:60, tip:"åŠ å·¥é£Ÿå“é€šå¸¸éˆ‰å«é‡éé«˜ï¼"}] },
            { id: 'sugary', name: "æ€–æ€å£º", title: "ç³–åˆ†å¹½éˆ", type: 'ghost', maxHp: 180, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/855.png", weakness: 'water', moves: [{name:"é©šåš‡", dmg:40, tip:"ç³–åˆ†æ³¢å‹•æœƒå½±éŸ¿æƒ…ç·’ç©©å®šã€‚"}, {name:"ç´…èŒ¶ç ²", dmg:70, tip:"å«ç³–é£²æ–™æ˜¯ç—›é¢¨çš„å…ƒå…‡ä¹‹ä¸€ï¼"}] },
            { id: 'boss', name: "å¡æ¯”ç¸", title: "ä»£è¬ç—‡å€™ç¾¤", type: 'normal', maxHp: 350, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/143.png", weakness: 'fighting', moves: [{name:"æ³°å±±å£“é ‚", dmg:90, tip:"é«”é‡éé‡æœƒåŠ é€Ÿè†é—œç¯€é€€åŒ–ã€‚"}, {name:"ç¡è¦º", dmg:0, heal:80, tip:"è‚¥èƒ–å®¹æ˜“å¼•ç™¼ç¡çœ å‘¼å¸ä¸­æ­¢ç—‡ã€‚"}] }
        ];

        // ç‰Œçµ„æ§‹æˆ (æ›´åƒ PTCG)
        const BASE_DECK = [
            ...Array(14).fill({ type: 'energy', name: "åŸºæœ¬èƒ½é‡" }),
            // åŸºç¤å¯¶å¯å¤¢ (å„3å¼µ)
            ...Array(3).fill({ type: 'pokemon', protoId: 'machop' }),
            ...Array(3).fill({ type: 'pokemon', protoId: 'riolu' }),
            ...Array(3).fill({ type: 'pokemon', protoId: 'scorbunny' }),
            ...Array(3).fill({ type: 'pokemon', protoId: 'sobble' }),
            // é€²åŒ–å¯¶å¯å¤¢ (å„2å¼µ)
            ...Array(2).fill({ type: 'pokemon', protoId: 'machamp' }),
            ...Array(2).fill({ type: 'pokemon', protoId: 'lucario' }),
            ...Array(2).fill({ type: 'pokemon', protoId: 'cinderace' }),
            ...Array(2).fill({ type: 'pokemon', protoId: 'inteleon' }),
            // è¨“ç·´å®¶
            ...Array(2).fill({ type: 'item', effect: 'potion', name: "å‚·è—¥", val: 50 }),
            ...Array(2).fill({ type: 'item', effect: 'switch', name: "å¯¶å¯å¤¢äº¤æ›¿" }),
            ...Array(2).fill({ type: 'item', effect: 'ball', name: "å…ˆæ©Ÿçƒ", desc: "æ‰¾åŸºç¤å¯¶å¯å¤¢" }),
            ...Array(2).fill({ type: 'item', effect: 'incense', name: "é€²åŒ–è–°é¦™", desc: "æ‰¾é€²åŒ–å¯¶å¯å¤¢" }),
            ...Array(3).fill({ type: 'supporter', effect: 'research', name: "åšå£«çš„ç ”ç©¶", val: 4 }),
            ...Array(2).fill({ type: 'supporter', effect: 'boss', name: "è€å¤§çš„æŒ‡ä»¤", val: 20 }),
        ];

        // --- çµ„ä»¶ ---

        const TypeBadge = ({ type }) => {
            const names = { fighting: 'æ ¼é¬¥', normal: 'ä¸€èˆ¬', water: 'æ°´', fire: 'ç«', ghost: 'å¹½éˆ' };
            const colors = { fighting: 'bg-red-700', normal: 'bg-stone-400', water: 'bg-blue-500', fire: 'bg-orange-500', ghost: 'bg-purple-700' };
            return <span className={`px-2 py-0.5 rounded text-xs font-bold text-white ${colors[type] || 'bg-gray-500'}`}>{names[type] || type}</span>;
        };

        const App = () => {
            const [scene, setScene] = useState('menu');
            const [enemyIdx, setEnemyIdx] = useState(0);
            
            // ç©å®¶ç‹€æ…‹
            const [activePkmn, setActivePkmn] = useState(null);
            const [bench, setBench] = useState([]);
            const [hand, setHand] = useState([]);
            const [deck, setDeck] = useState([]);
            const [discard, setDiscard] = useState([]);
            
            // æ•µäººç‹€æ…‹
            const [enemyHp, setEnemyHp] = useState(100);
            const [enemyNextMove, setEnemyNextMove] = useState(null);

            // å›åˆç‹€æ…‹
            const [turn, setTurn] = useState('player');
            const [energyAttached, setEnergyAttached] = useState(false);
            const [supporterUsed, setSupporterUsed] = useState(false);
            const [evolutionMode, setEvolutionMode] = useState(null); // å­˜å„²æ­£åœ¨æº–å‚™é€²åŒ–çš„å¡ç‰Œ index

            // UI
            const [msg, setMsg] = useState("");
            const [floater, setFloater] = useState(null);
            const [tip, setTip] = useState(null);
            const [anim, setAnim] = useState({ p: '', e: '' });

            // åˆå§‹åŒ–
            const initGame = () => { setEnemyIdx(0); startLevel(0, true); };

            const startLevel = (idx, fullReset = false) => {
                const enemy = ENEMIES[idx];
                setEnemyHp(enemy.maxHp);
                
                if (fullReset) {
                    const newDeck = [...BASE_DECK].sort(() => Math.random() - 0.5);
                    const initHand = newDeck.slice(0, 7);
                    const remaining = newDeck.slice(7);
                    
                    // åˆå§‹å¿…å®šæœ‰ä¸€éš»åŸºç¤å¯¶å¯å¤¢ä¸Šå ´ï¼Œè‹¥ç„¡å‰‡å¼·åˆ¶å¡ä¸€éš» (ç°¡åŒ–è¦å‰‡)
                    let starterCard = initHand.find(c => c.type === 'pokemon' && POKEMON_DB[c.protoId].stage === 'basic');
                    if (!starterCard) {
                        starterCard = { type: 'pokemon', protoId: 'machop' }; // ä¿åº•
                    }
                    
                    const starter = { 
                        ...POKEMON_DB[starterCard.protoId], 
                        currentHp: POKEMON_DB[starterCard.protoId].maxHp, 
                        energy: 0, 
                        instanceId: Date.now() 
                    };

                    // å¾æ‰‹ç‰Œç§»é™¤é‚£å¼µèµ·å§‹ç‰Œ
                    const finalHand = initHand.filter(c => c !== starterCard); // é€™è£¡å¯èƒ½ç§»é™¤å¤šå¼µä¸€æ¨£çš„ï¼Œæš«ä¸”ä¸å„ªåŒ–ç´°ç¯€

                    setActivePkmn(starter);
                    setBench([]);
                    setHand(finalHand);
                    setDeck(remaining);
                    setDiscard([]);
                } else {
                    // å›æ»¿è¡€
                    if(activePkmn) setActivePkmn(p => ({...p, currentHp: p.maxHp}));
                    setBench(prev => prev.map(p => ({...p, currentHp: p.maxHp})));
                    drawCard(1);
                }

                setTurn('player');
                setEnergyAttached(false);
                setSupporterUsed(false);
                setMsg(`é­é‡æ•µäººï¼š${enemy.name}ï¼`);
                setEnemyNextMove(enemy.moves[Math.floor(Math.random() * enemy.moves.length)]);
                setScene('battle');
            };

            const drawCard = (n = 1) => {
                if (deck.length === 0) {
                    if (discard.length === 0) return;
                    const newDeck = [...discard].sort(() => Math.random() - 0.5);
                    setDeck(newDeck);
                    setDiscard([]);
                    setTimeout(() => drawCard(n), 200);
                    return;
                }
                const drawn = deck.slice(0, n);
                setHand(h => [...h, ...drawn]);
                setDeck(d => d.slice(n));
            };

            // --- æ ¸å¿ƒé‚è¼¯ ---

            // 1. é™„èƒ½é‡
            const attachEnergy = (cardIdx) => {
                if (turn !== 'player' || energyAttached) return;
                setActivePkmn(p => ({ ...p, energy: p.energy + 1 }));
                discardCard(cardIdx);
                setEnergyAttached(true);
                setMsg(`ç‚º ${activePkmn.name} å……èƒ½ï¼`);
            };

            // 2. æ‰“å‡ºå¯¶å¯å¤¢ (åŸºç¤ç›´æ¥ä¸Šï¼Œé€²åŒ–éœ€é¸æ“‡ç›®æ¨™)
            const playPokemonCard = (cardIdx) => {
                if (turn !== 'player') return;
                const card = hand[cardIdx];
                const proto = POKEMON_DB[card.protoId];

                if (proto.stage === 'basic') {
                    if (bench.length >= 5) {
                        setMsg("å‚™æˆ°å€å·²æ»¿ï¼");
                        return;
                    }
                    const newPkmn = { ...proto, currentHp: proto.maxHp, energy: 0, instanceId: Date.now() + Math.random() };
                    setBench(b => [...b, newPkmn]);
                    discardCard(cardIdx, false); // ä¸é€²æ£„ç‰Œï¼Œè€Œæ˜¯é€²å ´
                    setMsg(`${newPkmn.name} é€²å…¥å‚™æˆ°å€ï¼`);
                } else {
                    // é€²å…¥é€²åŒ–æ¨¡å¼
                    setEvolutionMode(cardIdx);
                    setMsg(`è«‹é¸æ“‡ ${proto.evolvesFrom === 'machop' ? 'è…•åŠ›' : proto.evolvesFrom === 'riolu' ? 'åˆ©æ­è·¯' : proto.evolvesFrom === 'scorbunny' ? 'ç‚å…”å…’' : 'æ·šçœ¼èœ¥'} é€²è¡Œé€²åŒ–ï¼`);
                }
            };

            // åŸ·è¡Œé€²åŒ–
            const evolveTarget = (targetType, targetIdx) => {
                if (evolutionMode === null) return;
                
                const cardIdx = evolutionMode;
                const evoCard = hand[cardIdx];
                const evoProto = POKEMON_DB[evoCard.protoId];
                
                let targetPkmn = targetType === 'active' ? activePkmn : bench[targetIdx];
                
                // æª¢æŸ¥æ˜¯å¦ç¬¦åˆé€²åŒ–æ¢ä»¶
                if (targetPkmn.id !== evoProto.evolvesFrom) {
                    setMsg("é€™éš»å¯¶å¯å¤¢ç„¡æ³•é€²åŒ–æˆé€™å¼µå¡ï¼");
                    setEvolutionMode(null);
                    return;
                }

                // åŸ·è¡Œé€²åŒ–ï¼šç¹¼æ‰¿èƒ½é‡èˆ‡å‚·å®³
                const damageTaken = targetPkmn.maxHp - targetPkmn.currentHp;
                const newCurrentHp = evoProto.maxHp - damageTaken;

                const evolvedPkmn = {
                    ...evoProto,
                    currentHp: newCurrentHp,
                    energy: targetPkmn.energy,
                    instanceId: targetPkmn.instanceId
                };

                if (targetType === 'active') {
                    setActivePkmn(evolvedPkmn);
                    setAnim({ ...anim, p: 'evolve-anim' }); // é€²åŒ–ç‰¹æ•ˆ
                } else {
                    setBench(b => {
                        const newB = [...b];
                        newB[targetIdx] = evolvedPkmn;
                        return newB;
                    });
                }

                discardCard(cardIdx, false); // å¡ç‰Œè¢«æ¶ˆè€—
                setEvolutionMode(null);
                setMsg(`é€²åŒ–æˆåŠŸï¼${evolvedPkmn.name} ç™»å ´ï¼`);
                setTimeout(() => setAnim({ ...anim, p: '' }), 500);
            };

            // 3. ä½¿ç”¨è¨“ç·´å®¶
            const playTrainer = (cardIdx) => {
                if (turn !== 'player') return;
                const card = hand[cardIdx];
                if (card.type === 'supporter' && supporterUsed) {
                    setMsg("æ¯å›åˆé™ç”¨ä¸€å¼µæ”¯æ´è€…ï¼");
                    return;
                }

                let success = true;
                if (card.effect === 'potion') {
                    setActivePkmn(p => ({ ...p, currentHp: Math.min(p.maxHp, p.currentHp + card.val) }));
                    showFloater(`+${card.val}`, 'heal');
                } else if (card.effect === 'switch') {
                    if (bench.length === 0) success = false;
                    else swapPokemon(0); // ç°¡åŒ–ï¼šç›´æ¥æ›ç¬¬ä¸€éš»
                } else if (card.effect === 'research') {
                    setDiscard(d => [...d, ...hand.filter((_, i) => i !== cardIdx)]);
                    setHand([]);
                    drawCard(card.val);
                    success = false; // ç‰¹æ®Šè™•ç†ï¼Œå·²ç¶“æ‰‹å‹•æ£„ç‰Œ
                } else if (card.effect === 'ball' || card.effect === 'incense') {
                    const targetStage = card.effect === 'ball' ? 'basic' : 'evolution';
                    const foundIdx = deck.findIndex(c => c.type === 'pokemon' && POKEMON_DB[c.protoId].stage === targetStage);
                    if (foundIdx >= 0) {
                        const found = deck[foundIdx];
                        setHand(h => [...h, found]);
                        setDeck(d => {
                            const newD = d.filter((_, i) => i !== foundIdx);
                            return newD.sort(() => Math.random() - 0.5);
                        });
                        setMsg(`æ‰¾åˆ°äº† ${POKEMON_DB[found.protoId].name}ï¼`);
                    } else {
                        setMsg("ç‰Œåº«ä¸­æ²’æœ‰ç¬¦åˆçš„å°è±¡ï¼");
                    }
                } else if (card.effect === 'boss') {
                    setEnemyHp(h => Math.max(0, h - card.val));
                    drawCard(1);
                }

                if (success || card.effect === 'boss') discardCard(cardIdx);
                if (card.type === 'supporter') setSupporterUsed(true);
            };

            const discardCard = (idx, toDiscard = true) => {
                const card = hand[idx];
                setHand(h => h.filter((_, i) => i !== idx));
                if (toDiscard) setDiscard(d => [...d, card]);
            };

            const swapPokemon = (benchIdx) => {
                const newActive = bench[benchIdx];
                const oldActive = activePkmn;
                setActivePkmn(newActive);
                setBench(b => { const nb = [...b]; nb[benchIdx] = oldActive; return nb; });
                setMsg(`${newActive.name} ä¸Šå ´ï¼`);
            };

            const attack = (move) => {
                if (turn !== 'player' || activePkmn.energy < move.cost) {
                    setMsg("èƒ½é‡ä¸è¶³ï¼");
                    return;
                }
                
                const enemy = ENEMIES[enemyIdx];
                let dmg = move.dmg;
                if (activePkmn.type === enemy.weakness) dmg *= 2;

                setEnemyHp(h => Math.max(0, h - dmg));
                showFloater(activePkmn.type === enemy.weakness ? `-${dmg} (çµ•ä½³!)` : `-${dmg}`, 'dmg');
                setTip({ text: move.tip, type: 'good' });
                
                setAnim({ ...anim, p: 'attack-anim' }); // å¾…å¯¦ä½œ
                
                if (enemyHp - dmg <= 0) setTimeout(() => enemyIdx < ENEMIES.length-1 ? setScene('clear') : setScene('win'), 1000);
                else setTimeout(endTurn, 2000);
            };

            const endTurn = () => {
                setTurn('enemy');
                setTip(null);
                setEvolutionMode(null);
                setTimeout(enemyAction, 1000);
            };

            const enemyAction = () => {
                const move = enemyNextMove;
                const dmg = move.dmg || 0;
                
                if (dmg > 0) {
                    setActivePkmn(p => ({...p, currentHp: Math.max(0, p.currentHp - dmg)}));
                    showFloater(`-${dmg}`, 'dmg', true);
                }
                if (move.heal) setEnemyHp(h => Math.min(ENEMIES[enemyIdx].maxHp, h + move.heal));
                
                setTip({ text: move.tip, type: 'bad' });
                setMsg(`å°æ‰‹ä½¿ç”¨äº† ${move.name}ï¼`);

                if (activePkmn.currentHp - dmg <= 0) {
                    if (bench.length > 0) {
                        setTimeout(() => { swapPokemon(0); startPlayerTurn(); }, 2000);
                    } else {
                        setTimeout(() => setScene('lose'), 1500);
                    }
                } else {
                    setTimeout(startPlayerTurn, 2000);
                }
            };

            const startPlayerTurn = () => {
                setTurn('player');
                setEnergyAttached(false);
                setSupporterUsed(false);
                setEnemyNextMove(ENEMIES[enemyIdx].moves[Math.floor(Math.random()*ENEMIES[enemyIdx].moves.length)]);
                drawCard(1);
            };

            // UI è¼”åŠ©
            const showFloater = (text, type, isPlayer = false) => {
                setFloater({ text, type, isPlayer });
                setTimeout(() => setFloater(null), 1000);
            };

            // æ¸²æŸ“
            if (scene === 'menu') return (
                <div className="h-full flex flex-col items-center justify-center battle-bg">
                    <div className="bg-white/90 p-8 rounded-2xl shadow-xl text-center border-4 border-blue-400">
                        <h1 className="text-4xl font-bold mb-4 text-slate-800">å¯¶å¯å¤¢å¥åº·å¤§æˆ°<br/><span className="text-lg text-blue-600">é€²åŒ–è¦å‰‡ç‰ˆ</span></h1>
                        <p className="mb-6 text-slate-600">ä½¿ç”¨é€²åŒ–å¡ç‰Œï¼Œæ“Šæ•—å£ç¿’æ…£è»åœ˜ï¼</p>
                        <button onClick={initGame} className="bg-red-500 text-white px-8 py-3 rounded-full text-xl font-bold shadow hover:scale-105 transition">é–‹å§‹å°æˆ°</button>
                    </div>
                </div>
            );

            if (scene === 'win' || scene === 'lose') return (
                <div className="h-full flex items-center justify-center bg-slate-800 text-white flex-col">
                    <h2 className="text-6xl font-bold mb-4">{scene === 'win' ? 'å¤§å‹åˆ©ï¼' : 'æŒ‘æˆ°å¤±æ•—...'}</h2>
                    <button onClick={() => setScene('menu')} className="bg-white text-slate-900 px-6 py-2 rounded font-bold">å›ä¸»é¸å–®</button>
                </div>
            );

            if (scene === 'clear') return (
                <div className="h-full flex items-center justify-center bg-green-100 flex-col">
                    <h2 className="text-4xl font-bold text-green-700 mb-4">é—œå¡çªç ´ï¼</h2>
                    <button onClick={() => { setEnemyIdx(i => i+1); startLevel(enemyIdx+1); }} className="bg-blue-500 text-white px-6 py-2 rounded font-bold shadow">ä¸‹ä¸€é—œ</button>
                </div>
            );

            const enemy = ENEMIES[enemyIdx];

            return (
                <div className="h-full flex flex-col relative battle-bg">
                    {/* æµ®å‹•æ–‡å­— */}
                    {floater && <div className={`absolute z-50 text-4xl font-black damage-float ${floater.type === 'heal' ? 'text-green-500' : 'text-red-600'}`} 
                        style={{ top: floater.isPlayer ? '60%' : '30%', left: '50%' }}>{floater.text}</div>}
                    
                    {/* æç¤ºçª— */}
                    {tip && <div className={`absolute top-4 right-4 z-40 max-w-xs p-4 rounded border-l-4 shadow-lg tip-box ${tip.type === 'good' ? 'bg-yellow-50 border-yellow-500' : 'bg-red-50 border-red-500'}`}>
                        <div className="font-bold text-sm mb-1">{tip.type === 'good' ? 'ğŸ’¡ å¥åº·çŸ¥è­˜' : 'âš ï¸ å±å®³è­¦ç¤º'}</div>
                        <div className="text-xs">{tip.text}</div>
                    </div>}

                    {/* æ•µäººå€ */}
                    <div className="h-[30%] flex items-center justify-center relative">
                        <div className="relative flex flex-col items-center">
                            <img src={enemy.img} className={`h-40 object-contain drop-shadow-lg ${anim.e}`} />
                            <div className="absolute -bottom-6 bg-slate-800/90 text-white px-3 py-1 rounded text-center text-xs w-32 border border-slate-500">
                                <div>{enemy.name}</div>
                                <div className="w-full bg-gray-600 h-1.5 rounded mt-1 overflow-hidden"><div className="bg-red-500 h-full transition-all" style={{width: `${(enemyHp/enemy.maxHp)*100}%`}}></div></div>
                                <div>{enemyHp}/{enemy.maxHp}</div>
                            </div>
                        </div>
                    </div>

                    {/* ç©å®¶å€ */}
                    <div className="h-[40%] flex items-center justify-center relative px-4">
                        <div className={`relative mr-4 cursor-pointer ${evolutionMode !== null ? 'ring-4 ring-yellow-400 rounded-full' : ''}`} 
                             onClick={() => evolveTarget('active')}>
                            <img src={activePkmn.img} className={`h-48 object-contain drop-shadow-2xl ${anim.p}`} />
                            <div className="absolute -bottom-8 left-1/2 -translate-x-1/2 bg-white/95 px-3 py-2 rounded-lg border-2 border-slate-300 w-40 text-center shadow-lg">
                                <div className="flex justify-between items-center mb-1">
                                    <span className="font-bold text-sm">{activePkmn.name}</span>
                                    <TypeBadge type={activePkmn.type} />
                                </div>
                                <div className="w-full bg-gray-200 h-2 rounded overflow-hidden mb-1"><div className="bg-green-500 h-full transition-all" style={{width: `${(activePkmn.currentHp/activePkmn.maxHp)*100}%`}}></div></div>
                                <div className="text-xs font-bold text-slate-500 flex justify-between">
                                    <span>HP:{activePkmn.currentHp}</span><span>âš¡{activePkmn.energy}</span>
                                </div>
                            </div>
                        </div>

                        {/* æ‹›å¼è¡¨ */}
                        <div className="flex flex-col gap-2">
                            {activePkmn.moves.map((m, i) => (
                                <button key={i} onClick={() => attack(m)} disabled={turn !== 'player' || activePkmn.energy < m.cost}
                                    className={`px-3 py-2 rounded border-l-4 text-left w-40 text-xs font-bold shadow transition-all ${activePkmn.energy >= m.cost ? 'bg-white border-red-500 hover:translate-x-1' : 'bg-gray-200 border-gray-400 opacity-50'}`}>
                                    <div className="flex justify-between"><span>{m.name}</span><span>{m.dmg}</span></div>
                                    <div className="text-gray-400 mt-1">éœ€ {m.cost} èƒ½é‡</div>
                                </button>
                            ))}
                            {/* å‚™æˆ°å€ */}
                            <div className="mt-2 p-1 bg-slate-200/50 rounded flex gap-1">
                                {bench.map((p, i) => (
                                    <div key={p.instanceId} onClick={() => evolutionMode !== null ? evolveTarget('bench', i) : swapPokemon(i)}
                                         className={`w-10 h-10 rounded-full bg-white border-2 border-slate-300 overflow-hidden cursor-pointer hover:scale-110 transition relative ${evolutionMode !== null ? 'ring-2 ring-yellow-400' : ''}`}>
                                        <img src={p.img} className="w-full h-full object-contain" />
                                        {evolutionMode !== null && p.id === POKEMON_DB[hand[evolutionMode].protoId].evolvesFrom && 
                                            <div className="absolute inset-0 bg-green-500/30 animate-pulse"></div>}
                                    </div>
                                ))}
                                {[...Array(5-bench.length)].map((_,i) => <div key={i} className="w-10 h-10 rounded-full border-2 border-dashed border-slate-300"></div>)}
                            </div>
                        </div>
                    </div>

                    {/* æ‰‹ç‰Œå€ */}
                    <div className="h-[30%] bg-slate-900/80 backdrop-blur border-t border-slate-600 flex flex-col z-30">
                        <div className="px-4 py-1 flex justify-between text-xs text-white bg-black/30">
                            <span>{msg}</span>
                            <div className="flex gap-2">
                                {evolutionMode !== null && <button onClick={() => setEvolutionMode(null)} className="bg-gray-500 px-2 rounded">å–æ¶ˆé€²åŒ–</button>}
                                <button onClick={endTurn} disabled={turn!=='player'} className="bg-yellow-600 px-2 rounded disabled:opacity-50">çµæŸ</button>
                            </div>
                        </div>
                        <div className="flex-1 flex items-center gap-2 px-4 overflow-x-auto no-scrollbar py-2">
                            {hand.map((c, i) => {
                                const proto = c.type === 'pokemon' ? POKEMON_DB[c.protoId] : null;
                                const isEvo = proto && proto.stage === 'evolution';
                                return (
                                <div key={i} onClick={() => {
                                    if(c.type === 'energy') attachEnergy(i);
                                    else if(c.type === 'pokemon') playPokemonCard(i);
                                    else playTrainer(i);
                                }} className={`flex-shrink-0 w-20 h-28 rounded border-2 bg-slate-700 text-white p-1 flex flex-col relative card-container cursor-pointer
                                    ${c.type === 'pokemon' ? (isEvo ? 'border-yellow-400' : 'border-green-500') : c.type === 'energy' ? 'border-orange-500' : 'border-blue-500'}
                                    ${evolutionMode === i ? 'ring-4 ring-yellow-400 -translate-y-4' : ''}
                                `}>
                                    <div className="text-[9px] opacity-70 mb-1">{isEvo ? 'é€²åŒ–' : c.type === 'pokemon' ? 'åŸºç¤' : c.type === 'energy' ? 'èƒ½é‡' : 'é“å…·'}</div>
                                    <div className="font-bold text-xs leading-tight mb-auto">{c.name || proto.name}</div>
                                    <div className="self-center text-2xl">{c.type === 'pokemon' ? <img src={proto.img} className="w-10 h-10 object-contain"/> : c.type === 'energy' ? 'âš¡' : 'ğŸ’'}</div>
                                    {isEvo && <div className="text-[8px] text-yellow-300 mt-1 text-center">å¾ {POKEMON_DB[proto.evolvesFrom].name} é€²åŒ–</div>}
                                </div>
                            )})}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
